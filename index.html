<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Career Chute 3.0</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0e0f11;
  --panel: rgba(21, 23, 26, 0.8);
  --text: #f1f3f4;
  --muted: #9aa3ab;
  --accent: #5ad0ff;
  --ok: #79dd94;
  --warn: #ffbe5a;
  --bad: #ff6b6b;
  --line: rgba(255, 255, 255, 0.05);
  --success-glow: rgba(121, 221, 148, 0.4);
  
  /* Modern Design Tokens */
  --glass-bg: rgba(21, 23, 26, 0.8);
  --glass-border: rgba(255, 255, 255, 0.05);
  --shadow-soft: 0 4px 16px rgba(0, 0, 0, 0.12);
  --shadow-glow: 0 0 20px rgba(90, 208, 255, 0.3);
  --shadow-lift: 0 8px 24px rgba(0, 0, 0, 0.15);
  --gradient-primary: linear-gradient(135deg, #5ad0ff, #79dd94);
  --gradient-accent: linear-gradient(135deg, rgba(90, 208, 255, 0.8), rgba(90, 208, 255, 0.4));
  --backdrop-blur: blur(20px);
  --spring-easing: cubic-bezier(0.34, 1.56, 0.64, 1);
  
  /* Button Gradients - Dark Mode */
  --btn-primary: linear-gradient(135deg, #5ad0ff, #4fb3e6);
  --btn-secondary: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
  --btn-success: linear-gradient(135deg, #79dd94, #6bc584);
  --btn-warning: linear-gradient(135deg, #ffbe5a, #ffb84d);
  --btn-danger: linear-gradient(135deg, #ff6b6b, #ff5252);
}

/* Light Mode - Desert Clay Rose Design */
[data-theme="light"] {
  --bg: #faf8f5;
  --panel: rgba(255, 248, 245, 0.9);
  --text: #1a1a1a;
  --muted: #6b6b6b;
  --accent: #d97706;
  --ok: #059669;
  --warn: #d97706;
  --bad: #dc2626;
  --line: rgba(45, 45, 45, 0.08);
  --success-glow: rgba(5, 150, 105, 0.3);
  
  /* Light Mode Design Tokens */
  --glass-bg: rgba(255, 248, 245, 0.9);
  --glass-border: rgba(45, 45, 45, 0.08);
  --shadow-soft: 0 4px 16px rgba(0, 0, 0, 0.08);
  --shadow-glow: 0 0 20px rgba(217, 119, 6, 0.3);
  --shadow-lift: 0 8px 24px rgba(0, 0, 0, 0.12);
  --gradient-primary: linear-gradient(135deg, #2563eb, #1d4ed8);
  --gradient-accent: linear-gradient(135deg, rgba(217, 119, 6, 0.8), rgba(217, 119, 6, 0.4));
  
  /* Button Gradients - Light Mode */
  --btn-primary: linear-gradient(135deg, #2563eb, #1d4ed8);
  --btn-secondary: linear-gradient(135deg, rgba(45, 45, 45, 0.08), rgba(45, 45, 45, 0.04));
  --btn-success: linear-gradient(135deg, #059669, #047857);
  --btn-warning: linear-gradient(135deg, #f59e0b, #d97706);
  --btn-danger: linear-gradient(135deg, #dc2626, #b91c1c);
}

/* Typography */
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
  font-variant-numeric: tabular-nums;
  letter-spacing: -0.01em;
}

.mono {
  font-family: 'JetBrains Mono', 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
  font-variant-numeric: tabular-nums;
}

/* Button Styles with Gradients */
.modern-button.primary {
  background: var(--btn-primary);
  border: none;
  color: white;
  font-weight: 600;
  letter-spacing: -0.01em;
}

.modern-button.primary:hover {
  background: var(--btn-primary);
  transform: translateY(-1px);
  box-shadow: var(--shadow-lift);
}

.modern-button.secondary {
  background: var(--btn-secondary);
  border: 1px solid var(--glass-border);
  color: var(--text);
  font-weight: 500;
}

.modern-button.secondary:hover {
  background: var(--btn-secondary);
  transform: translateY(-1px);
  box-shadow: var(--shadow-soft);
}

/* Success/Warning/Danger buttons */
.modern-button[style*="background: var(--ok)"] {
  background: var(--btn-success) !important;
  border: none !important;
  color: white !important;
}

.modern-button[style*="background: var(--warn)"] {
  background: var(--btn-warning) !important;
  border: none !important;
  color: white !important;
}

.modern-button[style*="background: var(--bad)"] {
  background: var(--btn-danger) !important;
  border: none !important;
  color: white !important;
}

@keyframes confetti {
  0% { 
    transform: translateY(0) rotate(0deg) scale(1); 
    opacity: 1; 
  }
  50% {
    transform: translateY(50vh) rotate(360deg) scale(1.2);
    opacity: 0.8;
  }
  100% { 
    transform: translateY(100vh) rotate(720deg) scale(0.5); 
    opacity: 0; 
  }
}

@keyframes celebrationPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

@keyframes sparkle {
  0%, 100% { opacity: 0; transform: scale(0); }
  50% { opacity: 1; transform: scale(1); }
}

@keyframes slideIn {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

@keyframes breathe {
  0%, 100% { transform: scale(1); opacity: 0.6; }
  50% { transform: scale(1.3); opacity: 1; }
}

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Modern Design System Utility Classes */
.glass {
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  border: 1px solid var(--glass-border);
}

.glow {
  box-shadow: var(--shadow-glow);
}

.lift {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lift);
}

.spring {
  transition: all 400ms var(--spring-easing);
}

.fade-up {
  animation: fadeUp 400ms ease-out;
}

.glass-card {
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  border: 1px solid var(--glass-border);
  box-shadow: var(--shadow-soft);
  border-radius: 12px;
  transition: all 400ms var(--spring-easing);
}

.glass-card:hover {
  transform: translateY(-2px) scale(1.01);
  box-shadow: var(--shadow-lift), var(--shadow-glow);
}

.modern-button {
  height: 56px;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 400ms var(--spring-easing);
  border: none;
  font-size: 16px;
  min-width: 140px;
}

.modern-button:hover {
  transform: translateY(-2px) scale(1.01);
  box-shadow: var(--shadow-glow);
}

.modern-button:active {
  transform: scale(0.98);
}

.modern-button.primary {
  background: var(--gradient-primary);
  color: white;
}

.modern-button.secondary {
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  border: 1px solid var(--glass-border);
  color: var(--text);
}

.modern-button.ghost {
  background: transparent;
  border: 1px solid var(--glass-border);
  color: var(--muted);
}

.modern-button.ghost:hover {
  background: var(--glass-bg);
  color: var(--text);
}

/* Focus Session Panel Styles */
.focus-block {
  width: 20px;
  height: 20px;
  border: 2px solid var(--accent);
  border-radius: 4px;
  background: transparent;
  transition: all 400ms cubic-bezier(0.34, 1.56, 0.64, 1);
  position: relative;
  overflow: hidden;
}

.focus-block.filled {
  background: var(--ok);
  border-color: var(--ok);
  box-shadow: 0 0 12px rgba(121, 221, 148, 0.4);
  transform: scale(1.05);
}

.focus-block.filled::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  animation: fillSweep 600ms ease-out;
}

@keyframes fillSweep {
  0% { left: -100%; }
  100% { left: 100%; }
}

.confetti-piece {
  position: fixed;
  width: 10px;
  height: 10px;
  animation: confetti 3s ease-out forwards;
  z-index: 9999;
}

.celebration-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  z-index: 9998;
  display: none;
  align-items: center;
  justify-content: center;
}

.celebration-overlay.active {
  display: flex;
  animation: slideIn 0.3s ease-out;
}

.breathing-circle {
  width: 150px;
  height: 150px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--ok));
  animation: breathe 19s ease-in-out infinite;
}

.breathing-text {
  position: absolute;
  font-size: 24px;
  font-weight: 600;
  color: var(--text);
  margin-top: 200px;
}

.sync-indicator {
  font-size: 12px;
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 6px;
}

.sync-indicator.syncing { color: var(--warn); }
.sync-indicator.synced { color: var(--ok); }

/* Theme Toggle Switch */
#themeToggle:checked + span {
  background-color: var(--accent);
}

#themeToggle:checked + span span {
  transform: translateX(26px);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  overflow-x: hidden;
  font-size: 16px;
}

.task-card {
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  padding: 24px;
  margin: 16px 0;
  cursor: pointer;
  transition: all 400ms var(--spring-easing);
  width: 100%;
  display: flex;
  align-items: center;
  gap: 20px;
  min-height: 80px;
  box-shadow: var(--shadow-soft);
}

.task-card:hover {
  transform: translateY(-2px) scale(1.01);
  box-shadow: var(--shadow-lift), var(--shadow-glow);
  border-color: var(--accent);
}

.task-card.urgent { border-left: 4px solid var(--bad); }
.task-card.soon { border-left: 4px solid var(--warn); }
.task-card.ok { border-left: 4px solid var(--ok); }

.screen {
  display: none;
  min-height: 100vh;
  padding: 40px;
  max-width: 1200px;
  margin: 0 auto;
}

.screen.active { display: block; }

#focusMode {
  background: var(--bg);
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 20px;
}

.focus-timer {
  font-size: 72px;
  font-weight: 700;
  color: var(--accent);
  margin: 20px 0;
  font-variant-numeric: tabular-nums;
}

.focus-content {
  max-width: 600px;
  text-align: center;
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  padding: 40px;
  border-radius: 20px;
  border: 1px solid var(--glass-border);
  box-shadow: var(--shadow-lift);
}

.focus-title {
  font-size: 32px;
  font-weight: 700;
  margin-bottom: 20px;
  color: var(--accent);
  letter-spacing: -0.02em;
}

.focus-description {
  font-size: 18px;
  margin-bottom: 30px;
  line-height: 1.6;
}

.completion-criteria {
  background: var(--gradient-accent);
  backdrop-filter: var(--backdrop-blur);
  border: 1px solid var(--accent);
  border-radius: 12px;
  padding: 24px;
  margin: 20px 0;
  text-align: left;
  box-shadow: var(--shadow-soft);
}

.completion-criteria h4 {
  color: var(--accent);
  margin-bottom: 10px;
}

button {
  background: var(--gradient-primary);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 16px 32px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 400ms var(--spring-easing);
  min-width: 140px;
  height: 56px;
}

button:hover {
  transform: translateY(-2px) scale(1.01);
  box-shadow: var(--shadow-glow);
}

button:active {
  transform: scale(0.98);
}

button.secondary {
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  border: 1px solid var(--glass-border);
  color: var(--text);
}

button.ghost {
  background: transparent;
  border: 1px solid var(--glass-border);
  color: var(--muted);
}

button.ghost:hover {
  background: var(--glass-bg);
  color: var(--text);
}

button.danger {
  background: var(--bad);
  color: white;
}

.btn-group {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  justify-content: center;
  margin-top: 24px;
}

.next-task-options {
  display: grid;
  gap: 20px;
  margin-top: 32px;
  max-width: 500px;
}

.next-task-options button {
  width: 100%;
  padding: 20px;
  font-size: 18px;
  text-align: left;
  display: flex;
  align-items: center;
  gap: 12px;
}

.header {
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  border: 1px solid var(--glass-border);
  padding: 24px;
  margin-bottom: 32px;
  border-radius: 12px;
  box-shadow: var(--shadow-soft);
}

.header h1 {
  font-size: 32px;
  font-weight: 700;
  margin-bottom: 8px;
  letter-spacing: -0.02em;
}

.header .subtitle {
  color: var(--muted);
  font-size: 13px;
  font-weight: 500;
  letter-spacing: -0.02em;
}

input, select, textarea {
  width: 100%;
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  border: 1px solid var(--glass-border);
  color: var(--text);
  border-radius: 12px;
  padding: 16px;
  font-size: 16px;
  font-family: inherit;
  height: 56px;
  transition: all 400ms var(--spring-easing);
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: var(--shadow-glow);
}

label {
  display: block;
  color: var(--muted);
  font-size: 13px;
  margin-bottom: 8px;
  font-weight: 500;
  letter-spacing: -0.02em;
}

.form-group {
  margin-bottom: 24px;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin: 32px 0;
}

.stat-card {
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  padding: 24px;
  text-align: center;
  box-shadow: var(--shadow-soft);
  transition: all 400ms var(--spring-easing);
}

.stat-card:hover {
  transform: translateY(-2px) scale(1.01);
  box-shadow: var(--shadow-lift), var(--shadow-glow);
}

.stat-value {
  font-size: 36px;
  font-weight: 700;
  margin: 10px 0;
}

.stat-label {
  color: var(--muted);
  font-size: 14px;
}

progress {
  width: 100%;
  height: 8px;
  border-radius: 4px;
  margin-top: 8px;
}

progress::-webkit-progress-bar {
  background: #2b2f35;
  border-radius: 4px;
}

progress::-webkit-progress-value {
  background: var(--accent);
  border-radius: 4px;
}

.nav-bottom {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  border-top: 1px solid var(--glass-border);
  display: flex;
  justify-content: space-around;
  padding: 12px 0;
  z-index: 100;
  box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.12);
}

.nav-btn {
  background: transparent;
  border: none;
  color: var(--muted);
  font-size: 24px;
  padding: 8px 20px;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  min-width: auto;
}

.nav-btn span {
  font-size: 11px;
}

.nav-btn.active {
  color: var(--accent);
}

.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(8px);
  z-index: 2000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal-overlay.active {
  display: flex;
  animation: fadeUp 400ms ease-out;
}

.modal {
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  border-radius: 20px;
  padding: 32px;
  max-width: 500px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  border: 1px solid var(--glass-border);
  box-shadow: var(--shadow-lift);
}

.modal h2 {
  margin-bottom: 20px;
}

.exit-focus {
  position: fixed;
  top: 20px;
  left: 20px;
  background: transparent;
  border: 1px solid var(--line);
  color: var(--muted);
  font-size: 14px;
  padding: 8px 16px;
  min-width: auto;
  z-index: 1001;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}

.empty-state-emoji {
  font-size: 64px;
  margin-bottom: 20px;
}

.list-item {
  background: var(--glass-bg);
  backdrop-filter: var(--backdrop-blur);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: var(--shadow-soft);
  transition: all 400ms var(--spring-easing);
}

.list-item:hover {
  transform: translateY(-2px) scale(1.01);
  box-shadow: var(--shadow-lift), var(--shadow-glow);
}

.list-item-title {
  font-weight: 600;
  margin-bottom: 8px;
}

.list-item-meta {
  font-size: 14px;
  color: var(--muted);
}

.item-actions {
  display: flex;
  gap: 8px;
}

.icon-btn {
  background: transparent;
  border: none;
  color: var(--muted);
  font-size: 18px;
  padding: 4px 8px;
  cursor: pointer;
  min-width: auto;
}

.icon-btn:hover {
  color: var(--accent);
}

.badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  margin-left: 8px;
}

.badge.queued { background: #2b2f35; color: var(--muted); }
.badge.tailoring { background: rgba(255, 190, 90, 0.2); color: var(--warn); }
.badge.ready { background: rgba(121, 221, 148, 0.2); color: var(--ok); }
.badge.sent { background: rgba(90, 208, 255, 0.2); color: var(--accent); }

.icon {
  font-size: 24px;
  flex-shrink: 0;
}

@media (max-width: 768px) {
  .screen {
    padding: 16px;
    padding-bottom: 80px;
  }
  
  #focusMode {
    padding: 20px 16px;
    justify-content: flex-start;
    padding-top: 60px;
  }
  
  .focus-content {
    max-width: 100%;
    width: 100%;
    padding: 24px 20px;
    margin: 0;
  }
  
  .focus-timer {
    font-size: 48px;
    margin: 16px 0;
  }
  
  .focus-title {
    font-size: 20px;
    margin-bottom: 16px;
  }
  
  .task-card {
    padding: 16px;
  }
  
  /* Focus mode button layout for mobile */
  #focusMode .focus-content > div:first-child {
    flex-direction: row;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 16px;
    justify-content: center;
  }
  
  #focusMode .focus-content > div:first-child button {
    flex: 1;
    min-width: 120px;
    height: 40px;
    font-size: 14px;
    padding: 0 12px;
  }
  
  /* Focus mode form elements */
  #focusMode textarea,
  #focusMode input {
    width: 100%;
    box-sizing: border-box;
    margin-bottom: 12px;
  }
  
  /* Focus mode completion criteria */
  #focusMode .completion-criteria {
    font-size: 14px;
    line-height: 1.4;
    margin-bottom: 16px;
  }
}

/* iPhone 14 Pro Max specific optimizations */
@media (max-width: 430px) {
  #focusMode {
    padding: 16px 12px;
    padding-top: 50px;
  }
  
  .focus-content {
    padding: 20px 16px;
    border-radius: 16px;
  }
  
  .focus-timer {
    font-size: 42px;
    margin: 12px 0;
  }
  
  .focus-title {
    font-size: 18px;
    margin-bottom: 12px;
  }
  
  #focusMode .focus-content > div:first-child button {
    height: 40px;
    font-size: 13px;
    border-radius: 10px;
    padding: 0 10px;
  }
  
  /* General mobile button sizing */
  .modern-button {
    height: 44px;
    font-size: 14px;
    padding: 0 16px;
  }
  
  /* Task action buttons on mobile */
  .item-actions .icon-btn {
    width: 32px;
    height: 32px;
    font-size: 14px;
  }
  
  /* Ensure content fits within safe area */
  #focusMode .focus-content {
    max-height: calc(100vh - 100px);
    overflow-y: auto;
  }
}
</style>
</head>

<body>

<!-- Today Screen -->
<div id="today" class="screen active">
  <div style="position: sticky; top: 0; background: var(--bg); z-index: 10; padding: 16px 20px; border-bottom: 1px solid var(--line); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
    <div>
      <h1 style="margin: 0; font-size: 24px;">Today's Queue</h1>
      <div id="todayDate" style="font-size: 12px; color: var(--muted); margin-top: 2px; font-weight: 500;"></div>
    </div>
    <div style="display: flex; gap: 16px; align-items: center;">
      <div class="sync-indicator" id="syncStatus">
        <span>☁️</span>
        <span id="syncText">Loading...</span>
      </div>
      <div style="text-align: center;">
        <div style="font-size: 11px; color: var(--muted); margin-bottom: 2px;">Apps</div>
        <div style="font-size: 18px; font-weight: 700;">
          <span id="todayAppsComplete" style="color: var(--bad);">0</span><span style="color: var(--text);">/</span><span id="todayAppsTarget">3</span>
        </div>
      </div>
      <div style="text-align: center;">
        <div style="font-size: 11px; color: var(--muted); margin-bottom: 2px;">Network</div>
        <div style="font-size: 18px; font-weight: 700;">
          <span id="todayNetComplete" style="color: var(--bad);">0</span><span style="color: var(--text);">/</span><span id="todayNetTarget">2</span>
        </div>
      </div>
      <div style="text-align: center;">
        <div style="font-size: 11px; color: var(--muted); margin-bottom: 2px;">Time</div>
        <div style="font-size: 18px; font-weight: 700;" id="todayTimeTotal">0m</div>
      </div>
      <div style="text-align: center; padding-left: 8px; border-left: 1px solid var(--line);">
        <div style="font-size: 20px;">🔥</div>
        <div style="font-size: 14px; font-weight: 700;" id="todayStreak">0</div>
      </div>
    </div>
  </div>
  
  <!-- Compact Focus Session Panel -->
  <div id="focusSessionPanel" style="display: none; margin: 20px; padding: 16px; background: var(--glass-bg); backdrop-filter: var(--backdrop-blur); border: 1px solid var(--glass-border); border-radius: 12px; box-shadow: var(--shadow-soft);">
    
    <!-- Start Day Section -->
    <div id="startDaySection">
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <span style="color: var(--accent); font-size: 16px; font-weight: 600;">🎯 Focus Session</span>
          <label style="color: var(--muted); font-size: 13px;">Goal:</label>
          <input type="number" id="focusGoalInput" value="12" min="1" max="24" style="width: 60px; height: 32px; text-align: center; font-size: 13px;">
          <span style="color: var(--muted); font-size: 13px;">blocks</span>
        </div>
        <button onclick="startDay()" class="modern-button primary" style="height: 36px; padding: 0 16px; font-size: 14px;">Start Day</button>
      </div>
    </div>
    
    <!-- Active Session Section -->
    <div id="activeSessionSection" style="display: none;">
      <!-- Top Row: Session Info -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
          <span style="color: var(--accent); font-size: 15px; font-weight: 600;">🎯 Focus Session</span>
          <div style="display: flex; align-items: center; gap: 6px;">
            <span style="color: var(--muted); font-size: 11px;">Started:</span>
            <span id="sessionStartTime" style="font-weight: 600; color: var(--text); font-size: 12px;">10:00 AM</span>
          </div>
          <div style="display: flex; align-items: center; gap: 6px;">
            <span style="color: var(--muted); font-size: 11px;">Off-task:</span>
            <span id="offTaskTime" style="font-weight: 600; color: var(--warn); font-size: 12px;">0m</span>
          </div>
        </div>
      </div>
      
      <!-- Block Grid Row -->
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
        <span style="color: var(--muted); font-size: 11px; flex-shrink: 0;">Progress:</span>
        <div id="blockGrid" style="display: flex; gap: 3px; flex-wrap: wrap; flex: 1; min-width: 0;"></div>
      </div>
      
      <!-- Controls Row -->
      <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
        <!-- Chunk Duration -->
        <div style="display: flex; align-items: center; gap: 6px; flex-shrink: 0;">
          <span style="color: var(--muted); font-size: 11px;">Chunk:</span>
          <select id="chunkDuration" style="height: 28px; font-size: 12px; width: 60px;">
            <option value="30">30m</option>
            <option value="60">60m</option>
            <option value="90" selected>90m</option>
            <option value="120">120m</option>
          </select>
        </div>
        
        <!-- Chunk Control Button -->
        <button id="chunkControlBtn" onclick="startChunk()" class="modern-button primary" style="height: 28px; padding: 0 8px; font-size: 12px; flex-shrink: 0;">Start</button>
        
        <!-- Timer Display -->
        <div id="timerSection" style="display: none; flex-shrink: 0;">
          <div style="display: flex; align-items: center; gap: 6px;">
            <div id="chunkTimer" class="mono" style="font-size: 16px; font-weight: 600; color: var(--accent);">00:00</div>
            <button id="pauseBtn" onclick="pauseChunk()" class="modern-button secondary" style="height: 24px; padding: 0 6px; font-size: 11px;">⏸️</button>
            <button id="finishBtn" onclick="finishChunk()" class="modern-button primary" style="height: 24px; padding: 0 6px; font-size: 11px;">✓</button>
          </div>
        </div>
        
        <!-- ON/OFF Task Toggle -->
        <div id="taskToggleSection" style="display: none; flex-shrink: 0;">
          <div style="display: flex; gap: 6px;">
            <button id="onTaskBtn" onclick="setTaskMode('on-task')" class="modern-button" style="height: 28px; padding: 0 8px; font-size: 11px; font-weight: 600; background: var(--ok); color: white; border: none;">ON</button>
            <button id="offTaskBtn" onclick="setTaskMode('off-task')" class="modern-button" style="height: 28px; padding: 0 8px; font-size: 11px; font-weight: 600; background: var(--muted); color: white; border: none;">OFF</button>
          </div>
        </div>
      </div>
      
    </div>
  </div>
  
  <div style="padding: 20px;">
    <div id="todayTasks" style="margin-bottom: 120px;"></div>
  </div>
  
  <button onclick="showAddTaskModal()" class="secondary" style="position: fixed; bottom: 100px; left: 20px; right: 20px; max-width: 1160px; margin: 0 auto; z-index: 50; box-shadow: 0 -4px 16px rgba(0,0,0,0.12);">+ Add Task for Today</button>
</div>

<!-- Plan Screen -->
<div id="plan" class="screen">
  <div class="header" style="margin-bottom: 20px;">
    <h1 style="margin-bottom: 4px;">Weekly Plan</h1>
    <div class="subtitle">Manage your pipeline</div>
  </div>
  
  <div style="margin-bottom: 20px;">
    <h3 style="margin-bottom: 12px; font-size: 18px;">This Week's Targets</h3>
    <div class="stats-grid" style="grid-template-columns: 1fr; gap: 12px;">
      <div class="stat-card" style="padding: 16px; display: flex; align-items: center; justify-content: space-between;">
        <div>
          <div class="stat-label">Applications</div>
          <div class="stat-value" style="font-size: 24px; margin: 4px 0;"><span id="planAppsProgress">0</span>/<span id="planAppsTarget">15</span></div>
        </div>
        <progress id="planAppsBar" value="0" max="15" style="width: 120px; height: 6px;"></progress>
      </div>
      <div class="stat-card" style="padding: 16px; display: flex; align-items: center; justify-content: space-between;">
        <div>
          <div class="stat-label">Networking</div>
          <div class="stat-value" style="font-size: 24px; margin: 4px 0;"><span id="planNetProgress">0</span>/<span id="planNetTarget">10</span></div>
        </div>
        <progress id="planNetBar" value="0" max="10" style="width: 120px; height: 6px;"></progress>
      </div>
      <div class="stat-card" style="padding: 16px; display: flex; align-items: center; justify-content: space-between;">
        <div>
          <div class="stat-label">Events</div>
          <div class="stat-value" style="font-size: 24px; margin: 4px 0;"><span id="planEventsProgress">0</span>/<span id="planEventsTarget">1</span></div>
        </div>
        <div style="width: 120px; height: 6px; background: var(--line); border-radius: 3px; position: relative;">
          <div style="width: 0%; height: 100%; background: var(--accent); border-radius: 3px; transition: width 0.3s ease;"></div>
        </div>
      </div>
    </div>
  </div>
  
  <div style="margin-bottom: 30px;">
    <h3 style="margin-bottom: 16px;">Applications Pipeline</h3>
    <button onclick="showAddAppModal()" class="secondary" style="width: 100%; margin-bottom: 16px;">+ Add New Application</button>
    <div id="appsList"></div>
  </div>
  
  <div style="margin-bottom: 30px;">
    <h3 style="margin-bottom: 16px;">Networking Queue</h3>
    <button onclick="showAddContactModal()" class="secondary" style="width: 100%; margin-bottom: 16px;">+ Add Contact</button>
    <div id="contactsList"></div>
  </div>
  
  <div style="margin-bottom: 100px;">
    <h3 style="margin-bottom: 16px;">Upcoming Events</h3>
    <button onclick="showAddEventModal()" class="secondary" style="width: 100%; margin-bottom: 16px;">+ Add Event</button>
    <div id="eventsList"></div>
  </div>
</div>

<!-- Progress Screen -->
<div id="progress" class="screen">
  <div class="header">
    <h1>Progress</h1>
    <div class="subtitle">Track your job search journey</div>
  </div>
  
  <!-- New condensed dashboard -->
  <div id="progressDashboard"></div>
  
  <!-- Analytics Section -->
  <div id="analyticsSection" style="margin: 20px; padding: 24px; background: var(--glass-bg); backdrop-filter: var(--backdrop-blur); border: 1px solid var(--glass-border); border-radius: 16px; box-shadow: var(--shadow-soft);">
    <h2 style="margin: 0 0 20px 0; color: var(--accent); font-size: 24px; display: flex; align-items: center; gap: 8px;">
      📊 Analytics
    </h2>
    
    <!-- Daily Focus Summary -->
    <div id="dailyFocusSummary" style="margin-bottom: 24px;">
      <h3 style="margin: 0 0 16px 0; color: var(--text); font-size: 18px;">Today's Focus</h3>
      <div id="dailyFocusCard" style="padding: 20px; background: rgba(0,0,0,0.1); border-radius: 12px; text-align: center;">
        <div style="color: var(--muted); font-size: 14px; margin-bottom: 8px;">No focus session today</div>
        <div style="font-size: 12px; color: var(--muted);">Start a focus session to see your analytics</div>
      </div>
    </div>
    
    <!-- Weekly Overview -->
    <div id="weeklyOverview" style="margin-bottom: 24px;">
      <h3 style="margin: 0 0 16px 0; color: var(--text); font-size: 18px;">This Week</h3>
      <div id="weeklyFocusGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 16px;">
        <!-- 7 days will be populated here -->
      </div>
      <div id="weeklyStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
        <div style="text-align: center; padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px;">
          <div class="mono" style="font-size: 20px; font-weight: 600; color: var(--accent);" id="weeklyTotalBlocks">0</div>
          <div style="font-size: 12px; color: var(--muted);">Blocks</div>
        </div>
        <div style="text-align: center; padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px;">
          <div class="mono" style="font-size: 20px; font-weight: 600; color: var(--ok);" id="weeklyOnTaskPct">0%</div>
          <div style="font-size: 12px; color: var(--muted);">On-task</div>
        </div>
        <div style="text-align: center; padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px;">
          <div class="mono" style="font-size: 20px; font-weight: 600; color: var(--warn);" id="weeklyStreak">0</div>
          <div style="font-size: 12px; color: var(--muted);">Day Streak</div>
        </div>
      </div>
    </div>
    
    <!-- Badges & Achievements -->
    <div id="badgesSection" style="margin-bottom: 24px;">
      <h3 style="margin: 0 0 16px 0; color: var(--text); font-size: 18px;">🏆 Achievements</h3>
      <div id="badgesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; margin-bottom: 16px;">
        <!-- Badges will be populated here -->
      </div>
      <div id="streakStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px;">
        <div style="text-align: center; padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px;">
          <div class="mono" style="font-size: 18px; font-weight: 600; color: var(--warn);" id="currentStreak">0</div>
          <div style="font-size: 11px; color: var(--muted);">Current Streak</div>
        </div>
        <div style="text-align: center; padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px;">
          <div class="mono" style="font-size: 18px; font-weight: 600; color: var(--accent);" id="longestStreak">0</div>
          <div style="font-size: 11px; color: var(--muted);">Best Streak</div>
        </div>
        <div style="text-align: center; padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px;">
          <div class="mono" style="font-size: 18px; font-weight: 600; color: var(--ok);" id="totalBadges">0</div>
          <div style="font-size: 11px; color: var(--muted);">Badges Earned</div>
        </div>
      </div>
    </div>
    
    <!-- Insights & Achievements -->
    <div id="insightsSection">
      <h3 style="margin: 0 0 16px 0; color: var(--text); font-size: 18px;">Insights</h3>
      <div id="insightsCard" style="padding: 20px; background: linear-gradient(135deg, rgba(90, 208, 255, 0.1), rgba(121, 221, 148, 0.1)); border-radius: 12px; border: 1px solid rgba(90, 208, 255, 0.2);">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <div style="font-size: 24px;">🎯</div>
          <div>
            <div style="font-weight: 600; color: var(--text); font-size: 16px;" id="insightTitle">Ready to Focus</div>
            <div style="color: var(--muted); font-size: 14px;" id="insightSubtitle">Start your first focus session to unlock insights</div>
          </div>
        </div>
        <div style="font-size: 14px; color: var(--text);" id="insightText">
          Your focus analytics will appear here once you start tracking your work sessions.
        </div>
      </div>
    </div>
  </div>
  
  <!-- Application History -->
  <div id="applicationHistorySection" style="margin: 20px; padding: 24px; background: var(--glass-bg); backdrop-filter: var(--backdrop-blur); border: 1px solid var(--glass-border); border-radius: 16px; box-shadow: var(--shadow-soft);">
    <h2 style="margin: 0 0 20px 0; color: var(--accent); font-size: 24px; display: flex; align-items: center; gap: 8px;">
      📋 Application History
    </h2>
    <div id="applicationHistory"></div>
  </div>

  <!-- Legacy layout (hidden) -->
  <div id="progressLegacy" style="display:none; background: var(--panel); border: 1px solid var(--line); border-radius: 12px; padding: 20px; margin: 0 0 20px;">
    <h3 style="margin-bottom: 16px;">This Week</h3>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
      <span style="color: var(--muted);">Week Progress</span>
      <span style="font-weight: 600;" id="progressWeekDay">Day 1 of 7</span>
    </div>
    <div style="display: flex; gap: 8px; margin-bottom: 20px;">
      <div id="progressWeekDots"></div>
    </div>
    
    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(255, 190, 90, 0.2), rgba(255, 107, 107, 0.2)); border-radius: 12px; margin-bottom: 20px;">
      <div style="font-size: 48px; margin-bottom: 8px;">🔥</div>
      <div style="font-size: 36px; font-weight: 700; margin-bottom: 4px;" id="progressStreakCount">0</div>
      <div style="font-size: 14px; color: var(--muted);">day streak</div>
      <div style="font-size: 12px; color: var(--muted); margin-top: 8px;">Best: <span id="progressStreakBest">0</span> days</div>
    </div>
    
    <div style="display: grid; gap: 12px;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span>Applications</span>
        <span id="progressAppsStatus">0/15</span>
      </div>
      <progress id="progressAppsBar" value="0" max="15"></progress>
      
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span>Networking</span>
        <span id="progressNetStatus">0/10</span>
      </div>
      <progress id="progressNetBar" value="0" max="10"></progress>
      
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span>Events</span>
        <span id="progressEventsStatus">0/1</span>
      </div>
      <progress id="progressEventsBar" value="0" max="1"></progress>
    </div>
    
    <div id="progressOnTrack" style="margin-top: 20px; padding: 16px; border-radius: 12px; text-align: center; font-weight: 600;"></div>
  </div>
  
  <div style="display:none; background: var(--panel); border: 1px solid var(--line); border-radius: 12px; padding: 20px; margin: 0 0 20px;">
    <h3 style="margin-bottom: 16px;">Time This Week</h3>
    <div style="display: grid; gap: 12px;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span>Optimization Work</span>
        <span id="progressWeekOptTime">0 min</span>
      </div>
      <div style="font-size: 12px; color: var(--muted);">Resume tweaking, strategy</div>
      
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
        <span>Execution Work</span>
        <span id="progressWeekExecTime">0 min</span>
      </div>
      <div style="font-size: 12px; color: var(--muted);">Applications, networking, events</div>
    </div>
  </div>
  
  <div style="display:none; background: var(--panel); border: 1px solid var(--line); border-radius: 12px; padding: 20px; margin: 0 0 100px;">
    <h3 style="margin-bottom: 16px;">Application History</h3>
    <div id="applicationHistory"></div>
  </div>
</div>

<!-- Job Queue Screen -->
<div id="jobs" class="screen">
  <div class="header">
    <h1>Job Queue</h1>
    <div class="subtitle">Manage and prioritize your job applications</div>
  </div>
  
  <!-- Job Queue Controls -->
  <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
    <button class="modern-button primary" onclick="scanJobAlerts()">
      📧 Scan Gmail for Jobs
    </button>
    <button class="modern-button secondary" onclick="addJobManually()">
      ➕ Add Job Manually
    </button>
    <button class="modern-button secondary" onclick="exportJobQueue()">
      📊 Export to Spreadsheet
    </button>
    <button class="modern-button secondary" onclick="openJobPrioritizationSettings()">
      ⚙️ Prioritization Rules
    </button>
  </div>
  
  <!-- Job Queue Table -->
  <div style="background: var(--panel); border: 1px solid var(--line); border-radius: 12px; overflow: hidden;">
    <div id="jobQueueTable">
      <!-- Table will be populated by JavaScript -->
    </div>
  </div>
  
  <!-- Job Prioritization Settings Modal -->
  <div id="jobPrioritizationModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3>Job Prioritization Rules</h3>
        <button class="modal-close" onclick="closeJobPrioritizationSettings()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="prioritizationSettings">
          <!-- Settings will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Settings Screen -->
<div id="settings" class="screen">
  <div class="header">
    <h1>Settings</h1>
    <div class="subtitle">Customize your goals and preferences</div>
  </div>
  
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-bottom: 32px;">
    <div class="glass-card" style="padding: 24px;">
      <h3 style="margin-bottom: 16px; color: var(--accent);">Weekly Targets</h3>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;">
        <div class="form-group" style="margin-bottom: 0;">
          <label style="font-size: 12px; margin-bottom: 4px;">Applications</label>
          <input type="number" id="targetApps" min="1" value="15" style="height: 40px; font-size: 14px;">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label style="font-size: 12px; margin-bottom: 4px;">Networking</label>
          <input type="number" id="targetNet" min="1" value="10" style="height: 40px; font-size: 14px;">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label style="font-size: 12px; margin-bottom: 4px;">Events</label>
          <input type="number" id="targetEvents" min="1" value="1" style="height: 40px; font-size: 14px;">
        </div>
      </div>
      <button onclick="saveSettings()" style="width: 100%;">Save Targets</button>
    </div>
    
    <div class="glass-card" style="padding: 24px;">
      <h3 style="margin-bottom: 20px; color: var(--accent);">Appearance</h3>
    <div style="background: var(--glass-bg); backdrop-filter: var(--backdrop-blur); border: 1px solid var(--glass-border); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
      <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; margin: 0;">
        <span style="font-size: 16px; color: var(--text);">Theme</span>
        <div style="position: relative; display: inline-block; width: 50px; height: 24px;">
          <input type="checkbox" id="themeToggle" onchange="toggleTheme()" style="opacity: 0; width: 0; height: 0;">
          <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--muted); transition: .4s; border-radius: 24px;">
            <span style="position: absolute; content: ''; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;"></span>
          </span>
        </div>
      </label>
    </div>
      <p style="color: var(--muted); font-size: 14px; margin: 0;">Switch between dark and light themes</p>
    </div>
  </div>
  
  <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--line);">
    <h3 style="margin-bottom: 8px; font-size: 18px;">Guardrails</h3>
    <p style="color: var(--muted); font-size: 13px; margin-bottom: 12px;">Keep you on track and prevent optimization paralysis</p>
    
    <div style="background: var(--panel); border: 1px solid var(--line); border-radius: 12px; padding: 16px; margin-bottom: 12px;">
      <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; margin: 0;">
        <span style="font-size: 16px; color: var(--text);">Enable Guardrails</span>
        <input type="checkbox" id="guardrailsEnabled" onchange="toggleGuardrails()" style="width: auto; height: 24px; cursor: pointer;">
      </label>
    </div>
    
    <div id="guardrailsSettings" style="display: none; margin-left: 20px;">
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; align-items: end;">
        <div class="form-group" style="margin-bottom: 0;">
          <label style="font-size: 12px; margin-bottom: 4px;">Max tailoring time (min)</label>
          <input type="number" id="maxTailorTime" min="15" max="120" value="40" style="height: 32px;">
        </div>
        
        <div class="form-group" style="margin-bottom: 0;">
          <label style="font-size: 12px; margin-bottom: 4px;">Max daily optimization (min)</label>
          <input type="number" id="maxOptimizationTime" min="30" max="180" value="60" style="height: 32px;">
        </div>
        
        <div class="form-group" style="margin-bottom: 0;">
          <label style="font-size: 12px; margin-bottom: 4px;">Warning threshold (min)</label>
          <input type="number" id="warningThreshold" min="10" max="60" value="30" style="height: 32px;">
        </div>
      </div>
    </div>
  </div>
  
  <div style="margin-top: 40px; padding-top: 40px; border-top: 1px solid var(--line);">
    <h3 style="margin-bottom: 16px;">Account</h3>
    <div style="background: #0f1114; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
      <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">User ID</div>
      <div style="font-size: 14px; font-family: monospace;" id="userId">Loading...</div>
    </div>
    <p style="font-size: 14px; color: var(--muted); margin-bottom: 16px;">
      Your data syncs automatically across all devices using this ID.
    </p>
    <div style="background: var(--panel); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
      <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Sync Status:</div>
      <div id="debugSyncStatus" style="font-size: 14px; font-family: monospace;">Loading...</div>
    </div>
    
    <div style="background: var(--panel); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
      <div style="font-size: 12px; color: var(--muted); margin-bottom: 8px;">Sync Devices:</div>
      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        <input type="text" id="syncUserIdInput" placeholder="Enter User ID from other device" style="flex: 1; min-width: 200px; height: 36px; padding: 0 8px; border: 1px solid var(--line); border-radius: 6px; background: var(--bg); color: var(--text);">
        <button onclick="syncToUserId()" class="modern-button secondary" style="height: 36px; padding: 0 12px; font-size: 13px;">Sync</button>
      </div>
      <div style="font-size: 11px; color: var(--muted); margin-top: 6px;">
        Copy User ID from other device and paste above to sync data
      </div>
      <button onclick="listAllUsers()" class="modern-button ghost" style="height: 32px; padding: 0 8px; font-size: 12px; margin-top: 8px;">Show All User IDs</button>
      <button onclick="cleanupAndMigrateUsers()" class="modern-button primary" style="height: 32px; padding: 0 8px; font-size: 12px; margin-top: 8px;">Clean Up & Merge Users</button>
    </div>
    
    <div style="background: var(--panel); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
      <div style="font-size: 12px; color: var(--muted); margin-bottom: 8px;">Emergency Access:</div>
      <button onclick="forceOfflineMode()" class="modern-button secondary" style="height: 36px; padding: 0 12px; font-size: 13px;">Force Offline Mode</button>
      <div style="font-size: 11px; color: var(--muted); margin-top: 6px;">
        Use if app is stuck loading - will load from local storage
      </div>
    </div>
  </div>
  
  <div style="margin-top: 40px; padding-top: 40px; border-top: 1px solid var(--line);">
    <h3 style="margin-bottom: 16px;">📧 Email Integration</h3>
    <p style="font-size: 14px; color: var(--muted); margin-bottom: 16px;">
      Automatically scan Gmail for job alerts from LinkedIn and Indeed
    </p>
    
    <div style="background: var(--panel); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
      <div class="form-group" style="margin-bottom: 12px;">
        <label style="font-size: 12px; color: var(--muted); margin-bottom: 4px; display: block;">Google Client ID</label>
        <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
          <button class="modern-button secondary" onclick="loadOAuthConfig('netlify')" style="height: 32px; padding: 0 12px; font-size: 12px;">Netlify</button>
          <button class="modern-button secondary" onclick="loadOAuthConfig('localhost')" style="height: 32px; padding: 0 12px; font-size: 12px;">Localhost</button>
          <button class="modern-button secondary" onclick="saveOAuthConfig()" style="height: 32px; padding: 0 12px; font-size: 12px;">Save Current</button>
          <button class="modern-button secondary" onclick="testOAuthConfig()" style="height: 32px; padding: 0 12px; font-size: 12px;">Test Config</button>
          <button class="modern-button secondary" onclick="resetGmailAPI()" style="height: 32px; padding: 0 12px; font-size: 12px;">Reset API</button>
        </div>
        <input type="text" id="gmailClientId" placeholder="Your Google OAuth Client ID" oninput="handleGmailClientIdChange(this.value)" style="width: 100%; height: 36px; padding: 0 8px; border: 1px solid var(--line); border-radius: 6px; background: var(--bg); color: var(--text);">
        <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
          Get from <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: var(--accent);">Google Cloud Console</a>
        </div>
      </div>
      
      <div id="gmailConnectionStatus" style="margin-bottom: 12px;">
        <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Status:</div>
        <div id="gmailStatusText" style="font-size: 14px; color: var(--muted);">Not connected</div>
      </div>
      
      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        <button id="connectGmailBtn" onclick="connectGmail()" class="modern-button primary" style="height: 36px; padding: 0 16px; font-size: 13px; display: none;">Connect Gmail</button>
        <button id="disconnectGmailBtn" onclick="disconnectGmail()" class="modern-button secondary" style="height: 36px; padding: 0 16px; font-size: 13px; display: none;">Disconnect</button>
        <button id="scanEmailsBtn" onclick="scanJobAlerts()" class="modern-button primary" style="height: 36px; padding: 0 16px; font-size: 13px; display: none;">Scan for Jobs Now</button>
      </div>
      
      <div id="gmailLastScan" style="margin-top: 12px;"></div>
      
      <div id="lastScanInfo" style="margin-top: 12px; font-size: 12px; color: var(--muted); display: none;">
        <div id="lastScanTime"></div>
        <div id="lastScanResults"></div>
      </div>
    </div>
  </div>
  
  <div style="margin-top: 40px; padding-top: 40px; border-top: 1px solid var(--line); margin-bottom: 100px;">
    <h3 style="margin-bottom: 16px;">Data Management</h3>
    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
      <button onclick="exportData()" class="secondary">Export Data</button>
      <button onclick="importData()" class="secondary">Import Data</button>
      <button onclick="confirmReset()" class="danger">Reset All Data</button>
    </div>
  </div>
</div>

<!-- Focus Mode -->
<div id="focusMode" style="display: none;">
  <button class="exit-focus" onclick="exitFocus()">← Back to Queue</button>
  
  <div class="focus-content">
    <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px;">
      <div class="focus-timer" id="focusTimer">00:00</div>
      <button onclick="pauseTask()" class="secondary" style="height: 48px; padding: 0 20px;">⏸️ Pause</button>
      <button id="focusSwitchPairBtn" onclick="switchFocusPair()" class="ghost" style="display:none; height: 48px; padding: 0 20px;">↔︎ Switch</button>
    </div>
    
    <div id="optimizationProgress" style="display: none; margin-bottom: 20px;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
        <span>Today's optimization time</span>
        <span id="optProgressText">0/60 min</span>
      </div>
      <progress id="optProgressBar" value="0" max="60" style="width: 100%;"></progress>
    </div>
    
    <div class="focus-title" id="focusTitle"></div>
    <div class="focus-description" id="focusDescription"></div>
    
    <div id="focusMeta" style="margin: 20px 0; display: grid; gap: 16px; text-align: left;">
      <div id="focusUrlRow" style="display:none;">
        <div style="display:flex; gap:8px; align-items:center;">
          <input type="url" id="focusAppUrl" placeholder="https://..." style="flex:1;">
          <button class="secondary" onclick="saveFocusUrl()" style="min-width:80px;">Save</button>
        </div>
      </div>
      <div>
        <textarea id="focusNotes" rows="4" placeholder="Notes for this task..." oninput="debouncedSaveFocusNotes()" style="width: 100%; resize: vertical; min-height: 80px;"></textarea>
      </div>
    </div>
  
    <div class="completion-criteria" style="padding: 16px; margin: 16px 0;">
      <h4 style="margin-bottom: 8px;">Completion Criteria:</h4>
      <p id="focusCriteria" style="margin: 0;"></p>
    </div>
    
    <div class="btn-group">
      <button onclick="switchTask()" class="secondary">🔄 Switch Task</button>
      <button onclick="completeTask()">✓ Done</button>
    </div>
  </div>
</div>

<!-- Next Task Modal -->
<div id="nextTaskModal" class="modal-overlay">
  <div class="modal">
    <h2>Nice work! What's next?</h2>
    <div class="next-task-options">
      <button onclick="nextTaskRecommended()">
        <span>⭐</span>
        <span id="recommendedTaskText">Recommended task</span>
      </button>
      <button onclick="nextTaskRandom()" class="secondary">
        <span>🎲</span>
        <span>Choose for me</span>
      </button>
      <button onclick="nextTaskManual()" class="ghost">
        <span>📋</span>
        <span>Let me pick</span>
      </button>
    </div>
  </div>
</div>

<!-- Breathing Break -->
<div id="breathingBreak" class="celebration-overlay">
  <div style="text-align: center;">
    <div class="breathing-circle"></div>
    <div class="breathing-text" id="breathingText">Breathe in...</div>
    <button onclick="skipBreathing()" class="ghost" style="margin-top: 60px;">Skip →</button>
  </div>
</div>

<!-- Celebration -->
<div id="celebrationOverlay" class="celebration-overlay">
  <div style="text-align: center; max-width: 400px;">
    <div style="font-size: 80px; margin-bottom: 20px;" id="celebrationEmoji">🎉</div>
    <h2 style="margin-bottom: 12px;" id="celebrationTitle">Great work!</h2>
    <p style="color: var(--muted); margin-bottom: 30px;" id="celebrationMessage"></p>
    <button onclick="closeCelebration()">Continue →</button>
  </div>
</div>

<!-- Add Task Modal -->
<div id="addTaskModal" class="modal-overlay">
  <div class="modal">
    <h2>Add Task for Today</h2>
    <div class="form-group">
      <label>Task Type</label>
      <select id="newTaskType" onchange="updateTaskModalForType()">
        <option value="application">Job Application</option>
        <option value="networking">Networking Outreach</option>
        <option value="event">Event/Activity</option>
      </select>
    </div>
    
    <div id="taskSelectSection">
      <div class="form-group">
        <label>Select existing item</label>
        <select id="newTaskRef">
          <option value="">-- Select --</option>
        </select>
      </div>
      <div style="text-align: center; color: var(--muted); margin: 12px 0;">or</div>
    </div>
    
    <div id="quickAddSection" style="display: none;"></div>
    
    <button onclick="toggleQuickAdd()" class="secondary" style="width: 100%; margin-bottom: 12px;" id="quickAddToggle">+ Quick Add New</button>
    
    <div class="btn-group">
      <button onclick="addTaskToToday()">Add to Today</button>
      <button onclick="closeModal('addTaskModal')" class="ghost">Cancel</button>
    </div>
  </div>
</div>

<!-- Add Application Modal -->
<div id="addAppModal" class="modal-overlay">
  <div class="modal">
    <h2>Add New Application</h2>
    <div class="form-group">
      <label>Company Name</label>
      <input type="text" id="newAppCompany" placeholder="Acme Corp">
    </div>
    <div class="form-group">
      <label>Job Title</label>
      <input type="text" id="newAppRole" placeholder="Product Manager">
    </div>
    <div class="form-group">
      <label>Job URL</label>
      <input type="url" id="newAppUrl" placeholder="https://...">
    </div>
    <div class="form-group">
      <label>Deadline (optional)</label>
      <input type="date" id="newAppDeadline">
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea id="newAppNotes" rows="3"></textarea>
    </div>
    <div class="btn-group">
      <button onclick="addApplication()">Add Application</button>
      <button onclick="closeModal('addAppModal')" class="ghost">Cancel</button>
    </div>
  </div>
</div>

<!-- Add Contact Modal -->
<div id="addContactModal" class="modal-overlay">
  <div class="modal">
    <h2>Add Networking Contact</h2>
    <div class="form-group">
      <label>Name</label>
      <input type="text" id="newContactName" placeholder="Walter Smith">
    </div>
    <div class="form-group">
      <label>Relationship</label>
      <select id="newContactRel">
        <option value="Friend/Ally">Friend/Ally</option>
        <option value="Professional Contact">Professional Contact</option>
        <option value="Recruiter">Recruiter</option>
        <option value="Mentor">Mentor</option>
        <option value="Cold Contact">Cold Contact</option>
      </select>
    </div>
    <div class="form-group">
      <label>Company (optional)</label>
      <input type="text" id="newContactCompany">
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea id="newContactNotes" rows="3" placeholder="What to discuss, how they can help..."></textarea>
    </div>
    <div class="btn-group">
      <button onclick="addContact()">Add Contact</button>
      <button onclick="closeModal('addContactModal')" class="ghost">Cancel</button>
    </div>
  </div>
</div>

<!-- Add Event Modal -->
<div id="addEventModal" class="modal-overlay">
  <div class="modal">
    <h2>Add Event</h2>
    <div class="form-group">
      <label>Event Name</label>
      <input type="text" id="newEventName" placeholder="Career Fair">
    </div>
    <div class="form-group">
      <label>Date</label>
      <input type="date" id="newEventDate">
    </div>
    <div class="form-group">
      <label>Duration (minutes)</label>
      <input type="number" id="newEventDuration" value="120">
    </div>
    <div class="form-group">
      <label>Type</label>
      <select id="newEventType">
        <option value="fair">Career Fair</option>
        <option value="workshop">Workshop</option>
        <option value="info_session">Info Session</option>
        <option value="networking">Networking Event</option>
        <option value="interview">Interview</option>
      </select>
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea id="newEventNotes" rows="3"></textarea>
    </div>
    <div class="btn-group">
      <button onclick="addEvent()">Add Event</button>
      <button onclick="closeModal('addEventModal')" class="ghost">Cancel</button>
    </div>
  </div>
</div>

<!-- Guardrail Warning Modal -->
<div id="guardrailWarning" class="modal-overlay">
  <div class="modal" style="text-align: center;">
    <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
    <h2 id="guardrailTitle" style="margin-bottom: 16px;"></h2>
    <p id="guardrailMessage" style="color: var(--muted); margin-bottom: 24px;"></p>
    <div class="btn-group">
      <button onclick="closeModal('guardrailWarning')">Got it, moving on</button>
      <button onclick="continueAnyway()" class="ghost">Continue anyway</button>
    </div>
  </div>
</div>

<!-- Bottom Navigation -->
<div class="nav-bottom">
  <button class="nav-btn active" onclick="showScreen('today')">
    🎯
    <span>Today</span>
  </button>
  <button class="nav-btn" onclick="showScreen('plan')">
    📋
    <span>Plan</span>
  </button>
  <button class="nav-btn" onclick="showScreen('progress')">
    📊
    <span>Progress</span>
  </button>
  <button class="nav-btn" onclick="showScreen('jobs')">
    📋
    <span>Job Queue</span>
  </button>
  <button class="nav-btn" onclick="showScreen('settings')">
    ⚙️
    <span>Settings</span>
  </button>
</div>

<input type="file" id="importFileInput" accept=".json" style="display: none;">

<script src="https://apis.google.com/js/api.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// Emergency functions available immediately - GLOBAL SCOPE
window.emergencyOffline = function() {
  console.log('Emergency offline mode triggered');
  // Force update sync status
  const syncText = document.getElementById('syncText');
  if (syncText) syncText.textContent = 'Offline';
  
  // Load from localStorage
  try {
    const saved = localStorage.getItem('career_chute_backup');
    if (saved) {
      window.state = JSON.parse(saved);
      if (window.renderTodayTasks) window.renderTodayTasks();
      if (window.renderSettings) window.renderSettings();
      alert('Emergency offline mode activated!');
    } else {
      alert('No local data found. Starting fresh.');
    }
  } catch (error) {
    console.error('Emergency load error:', error);
    alert('Emergency mode failed. Please refresh the page.');
  }
};

// Auto-trigger emergency mode after 3 seconds
setTimeout(() => {
  const syncText = document.getElementById('syncText');
  if (syncText && syncText.textContent === 'Loading...') {
    console.warn('Auto-emergency mode triggered');
    window.emergencyOffline();
  }
}, 3000);

// Simple manual override - just change the text
window.forceOffline = function() {
  const syncText = document.getElementById('syncText');
  if (syncText) {
    syncText.textContent = 'Offline';
    console.log('Forced offline mode - sync text updated');
  }
};

// Firebase initialization
const firebaseConfig = {
  apiKey: "AIzaSyBRIlCVLNKtTqazJJeueLhYMZlBGlqISik",
  authDomain: "career-chute-b0be0.firebaseapp.com",
  projectId: "career-chute-b0be0",
  storageBucket: "career-chute-b0be0.firebasestorage.app",
  messagingSenderId: "42803696035",
  appId: "1:42803696035:web:da8b7d61c227fdc44c0a16"
};

// Debug Firebase configuration
console.log('Firebase Config:', firebaseConfig);
console.log('Current URL:', window.location.href);
console.log('Is HTTPS:', window.location.protocol === 'https:');

let db = null;
let firebaseAvailable = false;

// Initialize Firebase with timeout
function initializeFirebase() {
  return new Promise((resolve) => {
    const timeout = setTimeout(() => {
      console.warn('Firebase initialization timeout - falling back to offline mode');
      firebaseAvailable = false;
      resolve(false);
    }, 5000); // 5 second timeout

    try {
      if (typeof firebase === 'undefined') {
        console.warn('Firebase SDK not loaded - falling back to offline mode');
        clearTimeout(timeout);
        firebaseAvailable = false;
        resolve(false);
        return;
      }

      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      
      // Test connection
      db.enableNetwork().then(() => {
        clearTimeout(timeout);
        firebaseAvailable = true;
        console.log('Firebase initialized and connected successfully');
        console.log('Firebase URL:', db.app.options.databaseURL);
        resolve(true);
      }).catch(error => {
        console.warn('Firebase connection failed:', error);
        console.warn('Error details:', error.message, error.code);
        clearTimeout(timeout);
        firebaseAvailable = false;
        resolve(false);
      });
    } catch (error) {
      console.warn('Firebase initialization failed:', error);
      clearTimeout(timeout);
      firebaseAvailable = false;
      resolve(false);
    }
  });
}

// Single shared User ID for all devices
const SHARED_USER_ID = 'career-chute-shared-user';
let userId = SHARED_USER_ID;

// Always use the shared User ID
localStorage.setItem('career_chute_user_id', userId);

// State
let state = {
  version: '3.0.0',
  weekStart: null,
  targets: { apps: 15, networking: 10, events: 1 },
  applications: [],
  contacts: [],
  events: [],
  dailyTasks: {},
  completedThisWeek: { apps: 0, networking: 0, events: 0 },
  currentTask: null,
  focusStartTime: null,
  guardrails: {
    enabled: true,
    maxTailorTime: 40,
    maxOptimizationTime: 60,
    warningThreshold: 30
  },
  dailyTimeTracking: {},
  guardrailOverride: false,
  taskProgress: {},
  streaks: { current: 0, longest: 0, lastActiveDate: null },
  milestones: [],
  timeBlocking: null,
  theme: 'dark',
  gmail: {
    enabled: false,
    connected: false,
    userEmail: null,
    clientId: '',
    accessToken: null,
    tokenExpiry: null,
    lastScanTime: null,
    lastScanResults: { added: 0, duplicates: 0, emailsProcessed: 0 }
  }
};

let isSyncing = false;
let unsubscribe = null;

// Timer state
let chunkTimerInterval = null;
let chunkStartTime = null;
let chunkPausedTime = 0;

// Date utilities
function getTodayISO() {
  return new Date().toISOString().split('T')[0];
}

function getMonday() {
  const now = new Date();
  const day = now.getDay();
  const diff = (day === 0 ? -6 : 1 - day);
  const monday = new Date(now);
  monday.setDate(now.getDate() + diff);
  return monday.toISOString().split('T')[0];
}

function addDays(dateStr, days) {
  const date = new Date(dateStr + 'T00:00:00');
  date.setDate(date.getDate() + days);
  return date.toISOString().split('T')[0];
}

function isCurrentWeek(weekStart) {
  return weekStart === getMonday();
}

function getDaysDifference(date1, date2) {
  const d1 = new Date(date1);
  const d2 = new Date(date2);
  return Math.floor((d1 - d2) / (1000 * 60 * 60 * 24));
}

function formatDate(dateStr) {
  const date = new Date(dateStr + 'T00:00:00');
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

// Firebase sync
function updateSyncStatus(status, text) {
  const indicator = document.getElementById('syncStatus');
  const textEl = document.getElementById('syncText');
  const debugEl = document.getElementById('debugSyncStatus');
  
  if (!indicator || !textEl) return;
  
  indicator.className = 'sync-indicator';
  if (status === 'syncing') indicator.classList.add('syncing');
  if (status === 'synced') indicator.classList.add('synced');
  
  textEl.textContent = text;
  
  // Update debug status
  if (debugEl) {
    debugEl.textContent = `${status || 'idle'}: ${text} | Firebase: ${firebaseAvailable ? 'connected' : 'offline'}`;
  }
}

function saveToFirebase() {
  if (!firebaseAvailable || !db) {
    localStorage.setItem('career_chute_backup', JSON.stringify(state));
    return;
  }
  
  if (isSyncing) return;
  
  try {
    updateSyncStatus('syncing', 'Saving...');
    db.collection('users').doc(userId).set({
      ...state,
      lastUpdated: new Date().toISOString()
    }).then(() => {
      updateSyncStatus('synced', 'Synced');
      setTimeout(() => updateSyncStatus('', 'Cloud'), 2000);
    }).catch(error => {
      console.error('Save error:', error);
      updateSyncStatus('error', 'Error');
      localStorage.setItem('career_chute_backup', JSON.stringify(state));
    });
  } catch (error) {
    console.error('Save error:', error);
    updateSyncStatus('error', 'Error');
    localStorage.setItem('career_chute_backup', JSON.stringify(state));
  }
}

function loadFromFirebase() {
  if (!firebaseAvailable || !db) {
    console.log('Firebase not available, loading from localStorage');
    updateSyncStatus('error', 'Offline');
    loadFromLocalStorage();
    return;
  }
  
  try {
    updateSyncStatus('syncing', 'Loading...');
    
    // Add timeout for Firebase operations
    const loadTimeout = setTimeout(() => {
      console.warn('Firebase load timeout - falling back to localStorage');
      updateSyncStatus('error', 'Offline');
      loadFromLocalStorage();
    }, 10000); // 10 second timeout
    
    db.collection('users').doc(userId).get().then(doc => {
      clearTimeout(loadTimeout);
      
      if (doc.exists) {
        const data = doc.data();
        state = { ...state, ...data };
        delete state.lastUpdated;
      } else {
        loadFromLocalStorage();
      }
      
      initializeWeekAndDay();
      
      updateSyncStatus('synced', 'Synced');
      setTimeout(() => updateSyncStatus('', 'Cloud'), 2000);
      
      renderTodayTasks();
      renderSettings();
      setupRealtimeSync();
    }).catch(error => {
      clearTimeout(loadTimeout);
      console.error('Load error:', error);
      updateSyncStatus('error', 'Offline');
      loadFromLocalStorage();
    });
  } catch (error) {
    console.error('Load error:', error);
    updateSyncStatus('error', 'Offline');
    loadFromLocalStorage();
  }
}

function loadFromLocalStorage() {
  try {
    const backup = localStorage.getItem('career_chute_backup');
    if (backup) {
      state = { ...state, ...JSON.parse(backup) };
    }
  } catch (e) {
    console.error('LocalStorage load error:', e);
  }
  
  initializeWeekAndDay();
  applyTheme();
  renderTodayTasks();
  renderSettings();
}

function applyTheme() {
  document.documentElement.setAttribute('data-theme', state.theme);
}

function toggleTheme() {
  state.theme = state.theme === 'dark' ? 'light' : 'dark';
  applyTheme();
  saveToFirebase();
  renderSettings();
}

function initializeWeekAndDay() {
  if (!state.weekStart || !isCurrentWeek(state.weekStart)) {
    state.weekStart = getMonday();
    state.completedThisWeek = { apps: 0, networking: 0, events: 0 };
  }
  
  if (!state.tasks) state.tasks = {};
  if (!state.dailyTasks) state.dailyTasks = {};
  
  const today = getTodayISO();
  if (!state.dailyTasks[today]) {
    state.dailyTasks[today] = [];
  }
  
  if (!state.taskProgress) state.taskProgress = {};
  if (!state.streaks) state.streaks = { current: 0, longest: 0, lastActiveDate: null };
  if (!state.milestones) state.milestones = [];
  if (!state.dailyTimeTracking) state.dailyTimeTracking = {};
  
  // Handle carryover of unfinished tasks from previous days
  handleTaskCarryover();
}

function handleTaskCarryover() {
  const today = getTodayISO();
  const yesterday = addDays(today, -1);
  
  // Check if yesterday had unfinished tasks
  if (state.dailyTasks[yesterday]) {
    const unfinishedTasks = state.dailyTasks[yesterday].filter(t => !t.completed);
    
    if (unfinishedTasks.length > 0) {
      // Mark applications as in-progress in pipeline
      unfinishedTasks.forEach(task => {
        if (task.type === 'application' && task.refId) {
          const app = state.applications.find(a => a.id === task.refId);
          if (app && app.status === 'queued') {
            app.status = 'in_progress';
          }
        }
      });
      
      // Move unfinished tasks to today (optional - you might want to ask user first)
      // For now, we'll just mark them as in-progress in the pipeline
      console.log(`Found ${unfinishedTasks.length} unfinished tasks from yesterday`);
    }
  }
}

function setupRealtimeSync() {
  if (!firebaseAvailable || !db) return;
  if (unsubscribe) unsubscribe();
  
  try {
    console.log('Setting up realtime sync for user:', userId);
    unsubscribe = db.collection('users').doc(userId).onSnapshot({
      includeMetadataChanges: false
    }, doc => {
      console.log('Realtime update received:', doc.exists);
      if (doc.exists && !isSyncing) {
        const data = doc.data();
        if (data.lastUpdated) {
          isSyncing = true;
          state = { ...state, ...data };
          delete state.lastUpdated;
          
          initializeWeekAndDay();
          
          renderTodayTasks();
          renderProgress();
          renderPlanScreen();
          renderSettings();
          
          setTimeout(() => { isSyncing = false; }, 100);
        }
      }
    }, error => {
      console.error('Realtime sync error:', error);
      updateSyncStatus('error', 'Sync Error');
    });
  } catch (error) {
    console.error('Realtime sync setup error:', error);
    updateSyncStatus('error', 'Sync Setup Error');
  }
  
  // Set up periodic Gmail token expiry check
  if (state.gmail && state.gmail.connected) {
    setInterval(() => {
      checkTokenExpiry();
    }, 60000); // Check every minute
  }
}

// Navigation
function showScreen(screenId) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
  
  document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
  if (event && event.target) {
    event.target.closest('.nav-btn').classList.add('active');
  }
  
  if (screenId === 'today') {
    window.scrollTo(0, 0);
    renderTodayTasks();
  }
  if (screenId === 'plan') renderPlanScreen();
  if (screenId === 'progress') renderProgress();
  if (screenId === 'jobs') renderJobQueue();
  if (screenId === 'settings') renderSettings();
}

// Today's tasks rendering
function renderTodayTasks() {
  const today = getTodayISO();
  const todayTasks = state.dailyTasks[today] || [];
  const container = document.getElementById('todayTasks');
  
  if (todayTasks.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-emoji">📭</div>
        <p>No tasks queued for today</p>
        <p style="font-size: 14px;">Add tasks to get started</p>
      </div>
    `;
    updateTodayStats();
    return;
  }
  
  const activeTasks = todayTasks.filter(t => !t.completed);
  const completedTasks = todayTasks.filter(t => t.completed);
  
  const sortedActive = [...activeTasks].sort((a, b) => {
    const urgencyA = getTaskUrgency(a);
    const urgencyB = getTaskUrgency(b);
    const urgencyOrder = { urgent: 0, soon: 1, ok: 2 };
    return urgencyOrder[urgencyA] - urgencyOrder[urgencyB];
  });
  
  const mergedCompleted = mergeCompletedApplications(completedTasks);
  
  let html = '';
  
  if (sortedActive.length > 0) {
    html += sortedActive.map(task => renderTaskCard(task, false)).join('');
  }
  
  if (mergedCompleted.length > 0) {
    html += '<div style="margin-top: 32px; padding-top: 24px; border-top: 2px dashed var(--line);"></div>';
    html += mergedCompleted.map(item => {
      if (item.merged) {
        return renderMergedApplicationCard(item);
      } else {
        return renderTaskCard(item, true);
      }
    }).join('');
  }
  
  container.innerHTML = html;
  updateTodayStats();
  
  // Auto-queue today's events if not already present
  const todayISO = getTodayISO();
  const todaysEvents = state.events.filter(e => e.date === todayISO);
  todaysEvents.forEach(evt => {
    const exists = (state.dailyTasks[todayISO] || []).some(t => t.type === 'event' && t.refId === evt.id);
    if (!exists) {
      const eventTask = { id: generateId(), type: 'event', refId: evt.id, completed: !!evt.attended, estimatedTime: evt.duration || 60, notes: '' };
      state.dailyTasks[todayISO].push(eventTask);
    }
  });
  
  // Render focus panel
  renderFocusPanel();
  
  // Update today's date
  updateTodayDate();
}

function updateTodayDate() {
  const todayDateEl = document.getElementById('todayDate');
  if (todayDateEl) {
    const today = new Date();
    const options = { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      timeZone: 'America/Los_Angeles'
    };
    todayDateEl.textContent = today.toLocaleDateString('en-US', options);
  }
}

// Focus Session Panel Functions
function renderFocusPanel() {
  const panel = document.getElementById('focusSessionPanel');
  if (!panel) return;
  
  if (!state.timeBlocking || !state.timeBlocking.currentDay) {
    // Show start day section
    panel.style.display = 'block';
    document.getElementById('startDaySection').style.display = 'block';
    document.getElementById('activeSessionSection').style.display = 'none';
  } else {
    // Show active session
    panel.style.display = 'block';
    document.getElementById('startDaySection').style.display = 'none';
    document.getElementById('activeSessionSection').style.display = 'block';
    
    // Update session info
    const currentDay = state.timeBlocking.currentDay;
    document.getElementById('sessionStartTime').textContent = currentDay.startTime;
    document.getElementById('offTaskTime').textContent = formatMinutes(currentDay.activeChunk?.offTaskTime || 0);
    
    // Render block grid
    renderBlockGrid();
    
    // Handle active chunk timer
    if (currentDay.activeChunk && currentDay.activeChunk.status === 'active') {
      // Restore timer state
      const remainingTime = currentDay.activeChunk.remainingTime;
      const minutes = Math.floor(remainingTime / 60);
      const seconds = remainingTime % 60;
      const timerDisplay = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      document.getElementById('chunkTimer').textContent = timerDisplay;
      document.getElementById('timerSection').style.display = 'block';
      document.getElementById('taskToggleSection').style.display = 'block';
      document.getElementById('chunkControlBtn').textContent = 'Chunk Active';
      document.getElementById('chunkControlBtn').disabled = true;
      
      // Start timer if not already running
      if (!chunkTimerInterval) {
        chunkStartTime = new Date(Date.now() - (currentDay.activeChunk.plannedDuration * 60 - remainingTime) * 1000);
        startChunkTimer();
      }
      
      updateTimerButtons('active');
    } else if (currentDay.activeChunk && currentDay.activeChunk.status === 'paused') {
      // Show paused state
      const remainingTime = currentDay.activeChunk.remainingTime;
      const minutes = Math.floor(remainingTime / 60);
      const seconds = remainingTime % 60;
      const timerDisplay = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      document.getElementById('chunkTimer').textContent = timerDisplay;
      document.getElementById('timerSection').style.display = 'block';
      document.getElementById('taskToggleSection').style.display = 'block';
      document.getElementById('chunkControlBtn').textContent = 'Chunk Paused';
      document.getElementById('chunkControlBtn').disabled = true;
      
      updateTimerButtons('paused');
    }
  }
}

function startDay() {
  // Check if we need to save previous day first
  const today = getTodayISO();
  if (state.timeBlocking?.currentDay && state.timeBlocking.currentDay.date !== today) {
    saveDailyDataToHistory();
  }
  
  // Initialize time blocking if it doesn't exist
  if (!state.timeBlocking) {
    state.timeBlocking = {
      history: {},
      achievements: {
        badges: [],
        streaks: {
          workStreak: 0,
          goalStreak: 0,
          longestWork: 0,
          longestGoal: 0,
          currentWorkStreak: 0,
          currentGoalStreak: 0
        },
        stats: {
          totalBlocks: 0,
          totalOnTaskTime: 0,
          totalSessions: 0,
          bestDay: 0,
          perfectDays: 0
        }
      }
    };
  }
  
  // Start new day
  startNewDay();
}

function renderBlockGrid() {
  const grid = document.getElementById('blockGrid');
  if (!grid || !state.timeBlocking?.currentDay) return;
  
  const { goalBlocks, completedBlocks } = state.timeBlocking.currentDay;
  const totalBlocks = Math.max(goalBlocks, 24); // Show at least 24 blocks
  
  grid.innerHTML = '';
  
  for (let i = 0; i < totalBlocks; i++) {
    const block = document.createElement('div');
    block.className = 'focus-block';
    block.dataset.index = i;
    
    if (i < completedBlocks) {
      block.classList.add('filled');
    }
    
    grid.appendChild(block);
  }
}

function updateBlockGrid() {
  const grid = document.getElementById('blockGrid');
  if (!grid || !state.timeBlocking?.currentDay) return;
  
  const { goalBlocks, completedBlocks } = state.timeBlocking.currentDay;
  const totalBlocks = Math.max(goalBlocks, 24);
  
  // Update existing blocks
  const existingBlocks = grid.querySelectorAll('.focus-block');
  
  existingBlocks.forEach((block, index) => {
    const blockIndex = parseInt(block.dataset.index);
    
    if (blockIndex < completedBlocks) {
      if (!block.classList.contains('filled')) {
        block.classList.add('filled');
      }
    } else {
      block.classList.remove('filled');
    }
  });
  
  // Add new blocks if needed
  const currentBlockCount = existingBlocks.length;
  if (currentBlockCount < totalBlocks) {
    for (let i = currentBlockCount; i < totalBlocks; i++) {
      const block = document.createElement('div');
      block.className = 'focus-block';
      block.dataset.index = i;
      
      if (i < completedBlocks) {
        block.classList.add('filled');
      }
      
      grid.appendChild(block);
    }
  }
  
  // Remove excess blocks if goal decreased
  if (currentBlockCount > totalBlocks) {
    for (let i = totalBlocks; i < currentBlockCount; i++) {
      const blockToRemove = grid.querySelector(`[data-index="${i}"]`);
      if (blockToRemove) {
        blockToRemove.remove();
      }
    }
  }
}

function formatMinutes(minutes) {
  if (minutes < 60) {
    return `${minutes}m`;
  }
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
}

function startChunk() {
  if (!state.timeBlocking?.currentDay) return;
  
  const duration = parseInt(document.getElementById('chunkDuration').value) || 90;
  const now = new Date();
  
  state.timeBlocking.currentDay.activeChunk = {
    id: 'chunk_' + Date.now(),
    plannedDuration: duration,
    startTime: now.toLocaleTimeString('en-US', { 
      hour: 'numeric', 
      minute: '2-digit',
      hour12: true 
    }),
    elapsedTime: 0,
    status: 'active',
    onTaskTime: 0,
    offTaskTime: 0,
    remainingTime: duration * 60 // seconds
  };
  
  state.timeBlocking.currentDay.currentMode = 'on-task';
  state.timeBlocking.currentDay.modeStartTime = now.toISOString();
  
  // Start the countdown timer
  chunkStartTime = now;
  chunkPausedTime = 0;
  startChunkTimer();
  
  // Show timer and toggle sections
  document.getElementById('timerSection').style.display = 'block';
  document.getElementById('taskToggleSection').style.display = 'block';
  document.getElementById('chunkControlBtn').textContent = 'Chunk Active';
  document.getElementById('chunkControlBtn').disabled = true;
  
  // Update button states
  updateTimerButtons('active');
  updateTaskModeButtons(); // Set ON TASK as default active
  
  saveToFirebase();
  renderFocusPanel();
}

function pauseChunk() {
  if (!state.timeBlocking?.currentDay?.activeChunk) return;
  
  const activeChunk = state.timeBlocking.currentDay.activeChunk;
  
  if (activeChunk.status === 'active') {
    // Pause the timer
    activeChunk.status = 'paused';
    chunkPausedTime = Date.now();
    stopChunkTimer();
    
    // Update UI
    updateTimerButtons('paused');
    document.getElementById('pauseBtn').textContent = '▶️ Resume';
    
  } else if (activeChunk.status === 'paused') {
    // Resume the timer
    activeChunk.status = 'active';
    if (chunkPausedTime) {
      chunkPausedTime = Date.now() - chunkPausedTime;
    }
    startChunkTimer();
    
    // Update UI
    updateTimerButtons('active');
    document.getElementById('pauseBtn').textContent = '⏸️ Pause';
  }
  
  saveToFirebase();
}

function finishChunk() {
  if (!state.timeBlocking?.currentDay?.activeChunk) return;
  
  const activeChunk = state.timeBlocking.currentDay.activeChunk;
  
  // Stop the timer
  stopChunkTimer();
  
  // Log the final session before finishing
  const now = new Date();
  const currentMode = state.timeBlocking.currentDay.currentMode;
  const modeStartTime = new Date(state.timeBlocking.currentDay.modeStartTime);
  const finalSessionTime = Math.floor((now - modeStartTime) / 1000 / 60); // minutes
  
  if (finalSessionTime > 0) {
    const session = {
      mode: currentMode,
      duration: finalSessionTime,
      startTime: state.timeBlocking.currentDay.modeStartTime,
      endTime: now.toISOString()
    };
    
    if (!activeChunk.sessions) {
      activeChunk.sessions = [];
    }
    activeChunk.sessions.push(session);
    
    // Add final session time to counters
    if (currentMode === 'on-task') {
      activeChunk.onTaskTime += finalSessionTime;
      
      // Check for final block fills
      const totalOnTaskTime = activeChunk.onTaskTime;
      const blocksToFill = Math.floor(totalOnTaskTime / 30);
      const currentCompletedBlocks = state.timeBlocking.currentDay.completedBlocks;
      
      if (blocksToFill > currentCompletedBlocks) {
        state.timeBlocking.currentDay.completedBlocks = blocksToFill;
        updateBlockGrid();
      }
    } else {
      activeChunk.offTaskTime += finalSessionTime;
    }
  }
  
  // Calculate final elapsed time
  const totalElapsed = Math.floor((now - chunkStartTime - chunkPausedTime) / 1000);
  activeChunk.elapsedTime = totalElapsed;
  activeChunk.status = 'complete';
  
  // Add to chunks history
  state.timeBlocking.currentDay.chunks.push({
    ...activeChunk,
    completedAt: now.toISOString()
  });
  
  // Clear active chunk
  state.timeBlocking.currentDay.activeChunk = null;
  
  // Hide timer sections
  document.getElementById('timerSection').style.display = 'none';
  document.getElementById('taskToggleSection').style.display = 'none';
  document.getElementById('chunkControlBtn').textContent = 'Start Chunk';
  document.getElementById('chunkControlBtn').disabled = false;
  
  // Show completion message
  showChunkCompletion(totalElapsed);
  
  saveToFirebase();
  renderFocusPanel();
  
  // Check if we should save today's data to history
  saveDailyDataToHistory();
  
  // Check for achievements
  checkAchievements();
}

function startChunkTimer() {
  if (chunkTimerInterval) {
    clearInterval(chunkTimerInterval);
  }
  
  chunkTimerInterval = setInterval(updateChunkTimer, 1000);
}

function stopChunkTimer() {
  if (chunkTimerInterval) {
    clearInterval(chunkTimerInterval);
    chunkTimerInterval = null;
  }
}

function updateChunkTimer() {
  if (!state.timeBlocking?.currentDay?.activeChunk) {
    stopChunkTimer();
    return;
  }
  
  const activeChunk = state.timeBlocking.currentDay.activeChunk;
  
  if (activeChunk.status !== 'active') {
    return;
  }
  
  // Calculate remaining time
  const now = Date.now();
  const elapsed = Math.floor((now - chunkStartTime - chunkPausedTime) / 1000);
  const remaining = Math.max(0, activeChunk.remainingTime - elapsed);
  
  // Update display
  const minutes = Math.floor(remaining / 60);
  const seconds = remaining % 60;
  const timerDisplay = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  
  const timerElement = document.getElementById('chunkTimer');
  if (timerElement) {
    timerElement.textContent = timerDisplay;
    
    // Change color when time is running low
    if (remaining <= 300) { // 5 minutes
      timerElement.style.color = 'var(--warn)';
    } else if (remaining <= 60) { // 1 minute
      timerElement.style.color = 'var(--bad)';
    } else {
      timerElement.style.color = 'var(--accent)';
    }
  }
  
  // Auto-finish when timer reaches zero
  if (remaining === 0) {
    finishChunk();
  }
  
  // Update state
  activeChunk.elapsedTime = elapsed;
}

function updateTimerButtons(status) {
  const pauseBtn = document.getElementById('pauseBtn');
  const finishBtn = document.getElementById('finishBtn');
  
  if (status === 'active') {
    pauseBtn.textContent = '⏸️ Pause';
    pauseBtn.disabled = false;
    finishBtn.disabled = false;
  } else if (status === 'paused') {
    pauseBtn.textContent = '▶️ Resume';
    pauseBtn.disabled = false;
    finishBtn.disabled = false;
  }
}

function showChunkCompletion(elapsedSeconds) {
  const minutes = Math.floor(elapsedSeconds / 60);
  const seconds = elapsedSeconds % 60;
  const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
  
  // Show completion message
  alert(`🎉 Chunk completed in ${timeStr}!`);
}

function setTaskMode(mode) {
  if (!state.timeBlocking?.currentDay?.activeChunk) return;
  
  const now = new Date();
  const currentMode = state.timeBlocking.currentDay.currentMode;
  const modeStartTime = new Date(state.timeBlocking.currentDay.modeStartTime);
  const timeSpent = Math.floor((now - modeStartTime) / 1000 / 60); // minutes
  
  // Don't switch if already in the same mode
  if (currentMode === mode) return;
  
  // Log the previous session
  if (timeSpent > 0) {
    const session = {
      mode: currentMode,
      duration: timeSpent,
      startTime: state.timeBlocking.currentDay.modeStartTime,
      endTime: now.toISOString()
    };
    
    // Add to sessions array
    if (!state.timeBlocking.currentDay.activeChunk.sessions) {
      state.timeBlocking.currentDay.activeChunk.sessions = [];
    }
    state.timeBlocking.currentDay.activeChunk.sessions.push(session);
    
    // Add time to appropriate counter
    if (currentMode === 'on-task') {
      state.timeBlocking.currentDay.activeChunk.onTaskTime += timeSpent;
      
      // Check if we should fill a block (every 30 minutes of on-task time)
      const totalOnTaskTime = state.timeBlocking.currentDay.activeChunk.onTaskTime;
      const blocksToFill = Math.floor(totalOnTaskTime / 30);
      const currentCompletedBlocks = state.timeBlocking.currentDay.completedBlocks;
      
      if (blocksToFill > currentCompletedBlocks) {
        state.timeBlocking.currentDay.completedBlocks = blocksToFill;
        updateBlockGrid();
      }
    } else {
      state.timeBlocking.currentDay.activeChunk.offTaskTime += timeSpent;
    }
  }
  
  // Update mode
  state.timeBlocking.currentDay.currentMode = mode;
  state.timeBlocking.currentDay.modeStartTime = now.toISOString();
  
  // Update UI
  updateTaskModeButtons();
  document.getElementById('offTaskTime').textContent = formatMinutes(state.timeBlocking.currentDay.activeChunk.offTaskTime);
  
  saveToFirebase();
}

function updateTaskModeButtons() {
  const currentMode = state.timeBlocking?.currentDay?.currentMode;
  const onTaskBtn = document.getElementById('onTaskBtn');
  const offTaskBtn = document.getElementById('offTaskBtn');
  
  if (currentMode === 'on-task') {
    // ON TASK is active
    onTaskBtn.style.background = 'var(--ok)';
    onTaskBtn.style.color = 'white';
    onTaskBtn.style.transform = 'scale(1.05)';
    onTaskBtn.style.boxShadow = '0 0 20px rgba(121, 221, 148, 0.4)';
    
    offTaskBtn.style.background = 'var(--muted)';
    offTaskBtn.style.color = 'white';
    offTaskBtn.style.transform = 'scale(1)';
    offTaskBtn.style.boxShadow = 'none';
  } else {
    // OFF TASK is active
    offTaskBtn.style.background = 'var(--warn)';
    offTaskBtn.style.color = 'white';
    offTaskBtn.style.transform = 'scale(1.05)';
    offTaskBtn.style.boxShadow = '0 0 20px rgba(255, 190, 90, 0.4)';
    
    onTaskBtn.style.background = 'var(--muted)';
    onTaskBtn.style.color = 'white';
    onTaskBtn.style.transform = 'scale(1)';
    onTaskBtn.style.boxShadow = 'none';
  }
}

function incrementCompletedBlocks() {
  if (!state.timeBlocking?.currentDay) return;
  
  const currentDay = state.timeBlocking.currentDay;
  const { goalBlocks, completedBlocks } = currentDay;
  
  if (completedBlocks < goalBlocks) {
    currentDay.completedBlocks += 1;
    saveToFirebase();
    updateBlockGrid();
    
    // Check if goal is reached
    if (currentDay.completedBlocks >= goalBlocks) {
      showGoalAchieved();
    }
    
    // Check for achievements
    checkAchievements();
  }
}

function showGoalAchieved() {
  // Create celebration effect
  const grid = document.getElementById('blockGrid');
  if (grid) {
    grid.style.animation = 'pulse 1s ease-in-out';
  }
  
  // Show achievement message (could be enhanced with confetti, etc.)
  setTimeout(() => {
    alert('🎉 Daily focus goal achieved! Great work!');
  }, 500);
}

// Add pulse animation for goal achievement
const pulseKeyframes = `
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.02); }
  100% { transform: scale(1); }
}`;

// Add the keyframes to the document
const style = document.createElement('style');
style.textContent = pulseKeyframes;
document.head.appendChild(style);

function mergeCompletedApplications(completedTasks) {
  const appGroups = {};
  const otherTasks = [];
  
  completedTasks.forEach(task => {
    if ((task.type === 'application' || task.type === 'tailoring') && task.refId) {
      if (!appGroups[task.refId]) {
        appGroups[task.refId] = { tailoring: null, application: null };
      }
      if (task.type === 'tailoring') {
        appGroups[task.refId].tailoring = task;
      } else {
        appGroups[task.refId].application = task;
      }
    } else {
      otherTasks.push(task);
    }
  });
  
  const merged = [];
  
  Object.keys(appGroups).forEach(refId => {
    const group = appGroups[refId];
    if (group.tailoring && group.application) {
      const app = state.applications.find(a => a.id === refId);
      const celebrationEmojis = ['🎉', '🚀', '💪', '⭐', '🎊', '✨', '🔥', '💼'];
      const emoji = celebrationEmojis[Math.floor(Math.random() * celebrationEmojis.length)];
      
      merged.push({
        merged: true,
        refId,
        app,
        tailoringTask: group.tailoring,
        applicationTask: group.application,
        emoji,
        totalTime: (group.tailoring.actualTime || 0) + (group.application.actualTime || 0)
      });
    } else {
      if (group.tailoring) otherTasks.push(group.tailoring);
      if (group.application) otherTasks.push(group.application);
    }
  });
  
  return [...merged, ...otherTasks];
}

function renderMergedApplicationCard(item) {
  return `
    <div class="task-card ok" style="opacity: 0.8; min-height: 60px; background: linear-gradient(135deg, rgba(121, 221, 148, 0.1), rgba(90, 208, 255, 0.1));">
      <div class="icon">${item.emoji}</div>
      <div style="flex: 1;">
        <div style="font-weight: 600; margin-bottom: 4px;">
          ${item.app.company} - Application Complete!
        </div>
        <div style="font-size: 14px; color: var(--muted);">
          ${item.app.role} • ${item.totalTime} min total
        </div>
        <div style="font-size: 12px; color: var(--ok); margin-top: 4px;">
          ✓ Tailored (${item.tailoringTask.actualTime}m) • ✓ Submitted (${item.applicationTask.actualTime}m)
        </div>
      </div>
      <div style="font-size: 28px; color: var(--ok);">✓</div>
    </div>
  `;
}

function renderTaskCard(task, isCompleted) {
  const urgency = getTaskUrgency(task);
  const icon = getTaskIcon(task.type);
  const detail = getTaskDetail(task);
  const accumulatedTime = state.taskProgress[task.id] || 0;
  
  if (isCompleted) {
    const celebrationEmojis = {
      application: ['🎉', '🚀', '💪', '⭐'],
      networking: ['🤝', '🌟', '💫', '👏'],
      tailoring: ['✏️', '📝', '✨'],
      event: ['🎊', '🎯', '⭐']
    };
    const emojis = celebrationEmojis[task.type] || ['✓'];
    const emoji = emojis[Math.floor(Math.random() * emojis.length)];
    
    return `
      <div class="task-card ok" style="opacity: 0.7; min-height: 60px;">
        <div class="icon">${emoji}</div>
        <div style="flex: 1;">
          <div style="font-weight: 600; margin-bottom: 4px;">${detail.title}</div>
          <div style="font-size: 14px; color: var(--muted);">${detail.subtitle} • ${task.actualTime || 0}m</div>
        </div>
        <div style="font-size: 24px; color: var(--ok);">✓</div>
        <div class="item-actions" style="margin-left:8px;">
          <button class="icon-btn" onclick="event.stopPropagation(); editQueueItem('${task.id}')" title="Edit">✏️</button>
          <button class="icon-btn" onclick="event.stopPropagation(); deleteQueueItem('${task.id}')" title="Delete">🗑️</button>
        </div>
      </div>
    `;
  }
  
  return `
    <div class="task-card ${urgency}" onclick='enterFocus("${task.id}")'>
      <div class="icon">${icon}</div>
      <div style="flex: 1;">
        <div style="font-weight: 600; margin-bottom: 4px;">${detail.title}</div>
        <div style="font-size: 14px; color: var(--muted);">${detail.subtitle}</div>
        ${task.deadline ? `<div style="font-size: 12px; color: var(--warn); margin-top: 4px;">⏰ ${formatDate(task.deadline)}</div>` : ''}
        ${accumulatedTime > 0 ? `<div style="font-size: 12px; color: var(--accent); margin-top: 4px;">⏱️ ${accumulatedTime} min in progress</div>` : ''}
      </div>
      <div style="font-size: 14px; color: var(--muted);">
        ${task.estimatedTime} min
      </div>
      <div class="item-actions" style="margin-left:8px;">
        <button class="icon-btn" onclick="event.stopPropagation(); editQueueItem('${task.id}')" title="Edit">✏️</button>
        <button class="icon-btn" onclick="event.stopPropagation(); deleteQueueItem('${task.id}')" title="Delete">🗑️</button>
      </div>
    </div>
  `;
}

function updateTodayStats() {
  const today = getTodayISO();
  const todayTasks = state.dailyTasks[today] || [];
  
  const completedApps = todayTasks.filter(t => t.completed && t.type === 'application').length;
  const completedNet = todayTasks.filter(t => t.completed && t.type === 'networking').length;
  const addedApps = todayTasks.filter(t => t.type === 'application').length;
  const addedNet = todayTasks.filter(t => t.type === 'networking').length;
  
  const daysLeft = 7 - getDaysDifference(today, state.weekStart);
  const appsLeft = Math.max(0, state.targets.apps - state.completedThisWeek.apps);
  const netLeft = Math.max(0, state.targets.networking - state.completedThisWeek.networking);
  const dailyAppsQuota = Math.ceil(appsLeft / Math.max(1, daysLeft));
  const dailyNetQuota = Math.ceil(netLeft / Math.max(1, daysLeft));
  
  const appsCompleteEl = document.getElementById('todayAppsComplete');
  const appsTargetEl = document.getElementById('todayAppsTarget');
  if (appsCompleteEl && appsTargetEl) {
    appsCompleteEl.textContent = completedApps;
    appsTargetEl.textContent = dailyAppsQuota;
    
    // Color numerator based on completion
    if (completedApps === 0) {
      appsCompleteEl.style.color = 'var(--bad)';
    } else if (completedApps >= dailyAppsQuota) {
      appsCompleteEl.style.color = 'var(--ok)';
    } else {
      appsCompleteEl.style.color = 'var(--warn)';
    }
    
    // Color denominator based on tasks added to queue
    if (addedApps === 0) {
      appsTargetEl.style.color = 'var(--bad)';
    } else if (addedApps === 1) {
      appsTargetEl.style.color = '#ff8c42'; // Dark orange
    } else if (addedApps === 2) {
      appsTargetEl.style.color = 'var(--warn)'; // Orange
    } else if (addedApps === 3) {
      appsTargetEl.style.color = '#ffd700'; // Yellow
    } else if (addedApps >= dailyAppsQuota) {
      appsTargetEl.style.color = 'var(--ok)'; // Green
    } else {
      appsTargetEl.style.color = 'var(--muted)';
    }
  }
  
  const netCompleteEl = document.getElementById('todayNetComplete');
  const netTargetEl = document.getElementById('todayNetTarget');
  if (netCompleteEl && netTargetEl) {
    netCompleteEl.textContent = completedNet;
    netTargetEl.textContent = dailyNetQuota;
    
    // Color numerator based on completion
    if (completedNet === 0) {
      netCompleteEl.style.color = 'var(--bad)';
    } else if (completedNet >= dailyNetQuota) {
      netCompleteEl.style.color = 'var(--ok)';
    } else {
      netCompleteEl.style.color = 'var(--warn)';
    }
    
    // Color denominator based on tasks added to queue
    if (addedNet === 0) {
      netTargetEl.style.color = 'var(--bad)';
    } else if (addedNet === 1) {
      netTargetEl.style.color = '#ff8c42'; // Dark orange
    } else if (addedNet === 2) {
      netTargetEl.style.color = 'var(--warn)'; // Orange
    } else if (addedNet === 3) {
      netTargetEl.style.color = '#ffd700'; // Yellow
    } else if (addedNet >= dailyNetQuota) {
      netTargetEl.style.color = 'var(--ok)'; // Green
    } else {
      netTargetEl.style.color = 'var(--muted)';
    }
  }
  
  const todayTracking = state.dailyTimeTracking[today] || { optimization: 0, execution: 0 };
  const totalTime = todayTracking.optimization + todayTracking.execution;
  const timeEl = document.getElementById('todayTimeTotal');
  if (timeEl) {
    timeEl.textContent = totalTime > 0 ? `${totalTime}m` : '0m';
  }
  
  const streakEl = document.getElementById('todayStreak');
  if (streakEl) {
    streakEl.textContent = state.streaks.current || 0;
  }
}

function getTaskUrgency(task) {
  if (!task.deadline) return 'ok';
  const days = getDaysDifference(task.deadline, getTodayISO());
  if (days < 0) return 'urgent';
  if (days <= 2) return 'urgent';
  if (days <= 5) return 'soon';
  return 'ok';
}

function getTaskIcon(type) {
  const icons = {
    application: '💼',
    networking: '🤝',
    tailoring: '✏️',
    event: '📅'
  };
  return icons[type] || '📋';
}

function getTaskDetail(task) {
  if (task.type === 'application') {
    const app = state.applications.find(a => a.id === task.refId);
    if (app) {
      let action = 'Apply to';
      if (app.status === 'tailoring') action = 'Tailor resume & cover letter for';
      if (app.status === 'ready') action = 'Submit application to';
      return { title: `${action} ${app.company}`, subtitle: app.role };
    }
  }
  
  if (task.type === 'networking') {
    const contact = state.contacts.find(c => c.id === task.refId);
    if (contact) {
      return { title: `Reach out to ${contact.name}`, subtitle: contact.relationship };
    }
  }
  
  if (task.type === 'tailoring') {
    const app = state.applications.find(a => a.id === task.refId);
    if (app) {
      return { title: `Tailor resume & cover letter for ${app.company}`, subtitle: app.role };
    }
    return { title: 'Tailor resume & cover letter', subtitle: 'General tailoring session' };
  }
  
  if (task.type === 'event') {
    const event = state.events.find(e => e.id === task.refId);
    if (event) {
      return { title: event.name, subtitle: event.type };
    }
  }
  
  return { title: 'Task', subtitle: '' };
}

// Focus mode
function enterFocus(taskId) {
  const today = getTodayISO();
  const task = state.dailyTasks[today].find(t => t.id === taskId);
  if (!task || task.completed) return;
  
  state.currentTask = task;
  
  if (!state.taskProgress[taskId]) {
    state.taskProgress[taskId] = 0;
  }
  
  state.focusStartTime = Date.now();
  saveToFirebase();
  
  const detail = getTaskDetail(task);
  const criteria = getCompletionCriteria(task);
  
  document.getElementById('focusTitle').textContent = detail.title;
  document.getElementById('focusDescription').textContent = detail.subtitle;
  document.getElementById('focusCriteria').textContent = criteria;
  document.getElementById('focusNotes').value = task.notes || '';
  
  // URL row for applications/tailoring
  const app = (task.type === 'application' || task.type === 'tailoring') && task.refId ? state.applications.find(a => a.id === task.refId) : null;
  const focusUrlRow = document.getElementById('focusUrlRow');
  const focusAppUrl = document.getElementById('focusAppUrl');
  if (app) {
    focusUrlRow.style.display = 'block';
    focusAppUrl.value = app.url || '';
  } else {
    focusUrlRow.style.display = 'none';
  }
  
  // Paired switch button visibility
  const pairBtn = document.getElementById('focusSwitchPairBtn');
  if ((task.type === 'application' || task.type === 'tailoring') && task.refId) {
    pairBtn.style.display = 'inline-block';
  } else {
    pairBtn.style.display = 'none';
  }
  
  if (isOptimizationTask(task)) {
    const today = getTodayISO();
    const todayTracking = state.dailyTimeTracking[today] || { optimization: 0, execution: 0 };
    const currentTaskTime = state.taskProgress[taskId] || 0;
    const totalOptTime = todayTracking.optimization + currentTaskTime;
    
    document.getElementById('optimizationProgress').style.display = 'block';
    document.getElementById('optProgressText').textContent = 
      `${totalOptTime}/${state.guardrails.maxOptimizationTime} min`;
    document.getElementById('optProgressBar').value = totalOptTime;
    document.getElementById('optProgressBar').max = state.guardrails.maxOptimizationTime;
  } else {
    document.getElementById('optimizationProgress').style.display = 'none';
  }
  
  document.getElementById('focusMode').style.display = 'flex';
  
  startFocusTimer();
}

function startFocusTimer() {
  updateTimer();
  state.focusInterval = setInterval(updateTimer, 1000);
  
  if (state.guardrails.enabled && !state.guardrailOverride) {
    checkGuardrailsInterval();
  }
}

function checkGuardrailsInterval() {
  state.guardrailCheckInterval = setInterval(() => {
    if (!state.currentTask || !state.focusStartTime) {
      clearInterval(state.guardrailCheckInterval);
      return;
    }
    
    const elapsed = Math.floor((Date.now() - state.focusStartTime) / 1000 / 60);
    const task = state.currentTask;
    
    if (elapsed === state.guardrails.warningThreshold) {
      showGuardrailWarning(
        'Time Check',
        `You've been working on this task for ${elapsed} minutes. Consider wrapping up soon to keep momentum.`
      );
    }
    
    if (task.type === 'tailoring' && elapsed >= state.guardrails.maxTailorTime) {
      showGuardrailWarning(
        'Time to Move On',
        `You've hit your ${state.guardrails.maxTailorTime}-minute limit for resume tailoring. Time to take action instead of optimizing!`
      );
      state.guardrailOverride = false;
    }
    
    const today = getTodayISO();
    const todayTracking = state.dailyTimeTracking[today] || { optimization: 0, execution: 0 };
    
    if (isOptimizationTask(task) && todayTracking.optimization >= state.guardrails.maxOptimizationTime) {
      showGuardrailWarning(
        'Daily Optimization Limit Reached',
        `You've spent ${state.guardrails.maxOptimizationTime} minutes on optimization today. Switch to execution mode (applications, networking).`
      );
      state.guardrailOverride = false;
    }
  }, 60000);
}

function isOptimizationTask(task) {
  return task.type === 'tailoring';
}

function showGuardrailWarning(title, message) {
  if (state.guardrailOverride) return;
  
  document.getElementById('guardrailTitle').textContent = title;
  document.getElementById('guardrailMessage').textContent = message;
  document.getElementById('guardrailWarning').classList.add('active');
  
  if (state.focusInterval) {
    clearInterval(state.focusInterval);
  }
}

function continueAnyway() {
  state.guardrailOverride = true;
  closeModal('guardrailWarning');
  
  if (state.focusStartTime) {
    startFocusTimer();
  }
}

function updateTimer() {
  if (!state.focusStartTime) return;
  
  const elapsed = Math.floor((Date.now() - state.focusStartTime) / 1000);
  const taskId = state.currentTask?.id;
  const previousTime = taskId ? (state.taskProgress[taskId] || 0) : 0;
  const totalSeconds = previousTime * 60 + elapsed;
  
  const minutes = Math.floor(totalSeconds / 60);
  const seconds = totalSeconds % 60;
  
  document.getElementById('focusTimer').textContent = 
    `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  
  if (state.currentTask && isOptimizationTask(state.currentTask)) {
    const today = getTodayISO();
    const todayTracking = state.dailyTimeTracking[today] || { optimization: 0, execution: 0 };
    const currentMinutes = Math.floor(elapsed / 60);
    const totalOptTime = todayTracking.optimization + previousTime + currentMinutes;
    
    document.getElementById('optProgressText').textContent = 
      `${totalOptTime}/${state.guardrails.maxOptimizationTime} min`;
    document.getElementById('optProgressBar').value = totalOptTime;
  }
}

function exitFocus() {
  saveTaskProgress();
  
  if (state.focusInterval) {
    clearInterval(state.focusInterval);
    state.focusInterval = null;
  }
  
  if (state.guardrailCheckInterval) {
    clearInterval(state.guardrailCheckInterval);
    state.guardrailCheckInterval = null;
  }
  
  state.currentTask = null;
  state.focusStartTime = null;
  state.guardrailOverride = false;
  saveToFirebase();
  
  document.getElementById('focusMode').style.display = 'none';
  renderTodayTasks();
}

function pauseTask() {
  saveTaskProgress();
  exitFocus();
}

function switchTask() {
  saveTaskProgress();
  exitFocus();
}

function saveTaskProgress() {
  if (!state.currentTask || !state.focusStartTime) return;
  
  const elapsed = Math.floor((Date.now() - state.focusStartTime) / 1000 / 60);
  const taskId = state.currentTask.id;
  
  if (!state.taskProgress[taskId]) {
    state.taskProgress[taskId] = 0;
  }
  
  state.taskProgress[taskId] += elapsed;
  saveToFirebase();
}

// Focus notes/url handlers
let focusNotesSaveTimer = null;
function debouncedSaveFocusNotes() {
  if (!state.currentTask) return;
  const taskId = state.currentTask.id;
  const today = getTodayISO();
  const task = state.dailyTasks[today].find(t => t.id === taskId);
  if (!task) return;
  task.notes = document.getElementById('focusNotes').value;
  if (focusNotesSaveTimer) clearTimeout(focusNotesSaveTimer);
  focusNotesSaveTimer = setTimeout(() => {
    saveToFirebase();
  }, 500);
}

function saveFocusUrl() {
  if (!state.currentTask) return;
  const task = state.currentTask;
  if (!(task.type === 'application' || task.type === 'tailoring') || !task.refId) return;
  const app = state.applications.find(a => a.id === task.refId);
  if (!app) return;
  const url = document.getElementById('focusAppUrl').value.trim();
  app.url = url;
  saveToFirebase();
}

function switchFocusPair() {
  if (!state.currentTask || !state.currentTask.refId) return;
  const pairType = state.currentTask.type === 'application' ? 'tailoring' : 'application';
  const today = getTodayISO();
  const todayTasks = state.dailyTasks[today] || [];
  const pair = todayTasks.find(t => t.refId === state.currentTask.refId && t.type === pairType && !t.completed);
  if (pair) {
    pauseTask();
    enterFocus(pair.id);
  } else {
    // Create paired task if missing
    const newTask = { id: generateId(), type: pairType, refId: state.currentTask.refId, completed: false, estimatedTime: pairType === 'tailoring' ? 40 : 20, notes: '' };
    state.dailyTasks[today].push(newTask);
    saveToFirebase();
    pauseTask();
    enterFocus(newTask.id);
  }
}

function completeTask() {
  if (!state.currentTask) return;
  
  try {
    const today = getTodayISO();
    if (!state.dailyTasks[today]) {
      console.error('No tasks for today');
      return;
    }
    
    const task = state.dailyTasks[today].find(t => t.id === state.currentTask.id);
    
    if (!task) {
      console.error('Task not found');
      return;
    }
    
    task.completed = true;
    task.completedAt = new Date().toISOString();
    
    const elapsed = Math.floor((Date.now() - state.focusStartTime) / 1000 / 60);
    const taskId = task.id;
    const previousTime = state.taskProgress[taskId] || 0;
    const totalTime = previousTime + elapsed;
    
    task.actualTime = totalTime;
    
    if (!state.dailyTimeTracking[today]) {
      state.dailyTimeTracking[today] = { optimization: 0, execution: 0 };
    }
    
    if (isOptimizationTask(task)) {
      state.dailyTimeTracking[today].optimization += totalTime;
    } else {
      state.dailyTimeTracking[today].execution += totalTime;
    }
    
    if (state.taskProgress[taskId]) {
      delete state.taskProgress[taskId];
    }
    
    if (task.type === 'application') {
      state.completedThisWeek.apps++;
      
      const app = state.applications.find(a => a.id === task.refId);
      if (app) {
        if (app.status === 'queued') app.status = 'tailoring';
        else if (app.status === 'tailoring' || app.status === 'ready') {
          app.status = 'sent';
          app.dateSent = today;
        }
      }
      // Auto-complete paired tailoring task if present
      const pair = state.dailyTasks[today].find(t => t.refId === task.refId && t.type === 'tailoring' && !t.completed);
      if (pair) {
        pair.completed = true;
        pair.completedAt = new Date().toISOString();
        pair.actualTime = pair.actualTime || 0;
      }
    } else if (task.type === 'networking') {
      state.completedThisWeek.networking++;
      
      const contact = state.contacts.find(c => c.id === task.refId);
      if (contact) {
        contact.lastContact = today;
        contact.status = 'contacted';
      }
    } else if (task.type === 'event') {
      state.completedThisWeek.events++;
      
      const event = state.events.find(e => e.id === task.refId);
      if (event) event.attended = true;
    }
    
    updateStreaks();
    checkMilestones();
    
    saveToFirebase();
    
    exitFocus();
    
    setTimeout(() => {
      showCelebration(task);
    }, 100);
    
  } catch (err) {
    console.error('Error completing task:', err);
    alert('Error completing task. Your progress has been saved.');
    exitFocus();
  }
}

function getCompletionCriteria(task) {
  if (task.type === 'application') {
    const app = state.applications.find(a => a.id === task.refId);
    if (app) {
      if (app.status === 'queued') return 'Open the job posting, read through requirements, save any questions or notes';
      if (app.status === 'tailoring') return 'Update resume & cover letter to match job description, highlight relevant experience, save tailored versions';
      if (app.status === 'ready') return 'Submit application through their system, attach tailored resume, note confirmation number';
    }
  }
  
  if (task.type === 'networking') {
    return 'Draft and send your message, personalize based on your relationship, set follow-up reminder if needed';
  }
  
  if (task.type === 'tailoring') {
    return 'Match keywords from target job descriptions, lead with relevant achievements, quantify impact where possible, keep resume concise and scannable, customize cover letter for each role';
  }
  
  if (task.type === 'event') {
    return 'Attend the event, take notes on key connections, follow up with contacts made';
  }
  
  return 'Complete the task as planned';
}

function updateStreaks() {
  const today = getTodayISO();
  const yesterday = addDays(today, -1);
  
  if (state.streaks.lastActiveDate === yesterday) {
    state.streaks.current++;
  } else if (state.streaks.lastActiveDate !== today) {
    state.streaks.current = 1;
  }
  
  state.streaks.lastActiveDate = today;
  
  if (state.streaks.current > state.streaks.longest) {
    state.streaks.longest = state.streaks.current;
  }
  
  saveToFirebase();
}

function checkMilestones() {
  const milestones = [
    { id: 'first_app', condition: state.completedThisWeek.apps >= 1 },
    { id: 'five_apps', condition: state.completedThisWeek.apps >= 5 },
    { id: 'ten_apps', condition: state.completedThisWeek.apps >= 10 },
    { id: 'week_complete', condition: state.completedThisWeek.apps >= state.targets.apps },
    { id: 'streak_3', condition: state.streaks.current >= 3 },
    { id: 'streak_7', condition: state.streaks.current >= 7 }
  ];
  
  milestones.forEach(milestone => {
    if (milestone.condition && !state.milestones.includes(milestone.id)) {
      state.milestones.push(milestone.id);
    }
  });
}

function showCelebration(task) {
  createConfetti();
  
  let emoji = '🎉';
  let title = 'Great work!';
  let message = 'Task completed successfully!';
  
  if (task.type === 'application') {
    emoji = '💼';
    title = 'Application sent!';
    message = 'One step closer to your next role!';
  } else if (task.type === 'networking') {
    emoji = '🤝';
    title = 'Connection made!';
    message = 'Your network is growing!';
  } else if (task.type === 'tailoring') {
    emoji = '✨';
    title = 'Resume & cover letter polished!';
    message = 'Now go apply!';
  }
  
  document.getElementById('celebrationEmoji').textContent = emoji;
  document.getElementById('celebrationTitle').textContent = title;
  document.getElementById('celebrationMessage').textContent = message;
  document.getElementById('celebrationOverlay').classList.add('active');
  
  setTimeout(() => {
    closeCelebration();
  }, 2000);
}

function createConfetti() {
  const colors = ['#5ad0ff', '#79dd94', '#ffbe5a', '#ff6b6b'];
  for (let i = 0; i < 30; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti-piece';
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.animationDelay = Math.random() * 0.5 + 's';
    document.body.appendChild(confetti);
    
    setTimeout(() => confetti.remove(), 3000);
  }
}

function closeCelebration() {
  document.getElementById('celebrationOverlay').classList.remove('active');
  startBreathingBreak();
}

function startBreathingBreak() {
  const today = getTodayISO();
  const remaining = (state.dailyTasks[today] || []).filter(t => !t.completed);
  
  if (remaining.length === 0) {
    alert('All done for today! Great work!');
    return;
  }
  
  document.getElementById('breathingBreak').classList.add('active');
  
  const phases = [
    { text: 'Breathe in...', duration: 4000 },
    { text: 'Hold...', duration: 7000 },
    { text: 'Breathe out...', duration: 8000 }
  ];
  
  let phaseIndex = 0;
  
  function nextPhase() {
    if (phaseIndex >= phases.length) {
      skipBreathing();
      return;
    }
    
    const breathingText = document.getElementById('breathingText');
    if (breathingText) {
      breathingText.textContent = phases[phaseIndex].text;
    }
    
    state.breathingTimeout = setTimeout(() => {
      phaseIndex++;
      nextPhase();
    }, phases[phaseIndex].duration);
    
    phaseIndex++;
  }
  
  nextPhase();
}

function skipBreathing() {
  if (state.breathingTimeout) {
    clearTimeout(state.breathingTimeout);
  }
  document.getElementById('breathingBreak').classList.remove('active');
  showNextTaskOptions();
}

function showNextTaskOptions() {
  const today = getTodayISO();
  const remaining = (state.dailyTasks[today] || []).filter(t => !t.completed);
  
  if (remaining.length === 0) {
    alert('All done for today! Great work!');
    return;
  }
  
  const recommended = getRecommendedTask(remaining);
  if (recommended) {
    const detail = getTaskDetail(recommended);
    document.getElementById('recommendedTaskText').textContent = detail.title;
  }
  
  document.getElementById('nextTaskModal').classList.add('active');
}

function getRecommendedTask(tasks) {
  const urgent = tasks.filter(t => getTaskUrgency(t) === 'urgent');
  if (urgent.length > 0) return urgent[0];
  
  const soon = tasks.filter(t => getTaskUrgency(t) === 'soon');
  if (soon.length > 0) return soon[0];
  
  const lastType = state.currentTask?.type;
  const different = tasks.filter(t => t.type !== lastType);
  if (different.length > 0) return different[0];
  
  return tasks[0];
}

function nextTaskRecommended() {
  document.getElementById('nextTaskModal').classList.remove('active');
  const today = getTodayISO();
  const remaining = state.dailyTasks[today].filter(t => !t.completed);
  const recommended = getRecommendedTask(remaining);
  if (recommended) enterFocus(recommended.id);
}

function nextTaskRandom() {
  document.getElementById('nextTaskModal').classList.remove('active');
  const today = getTodayISO();
  const remaining = state.dailyTasks[today].filter(t => !t.completed);
  const random = remaining[Math.floor(Math.random() * remaining.length)];
  if (random) enterFocus(random.id);
}

function nextTaskManual() {
  document.getElementById('nextTaskModal').classList.remove('active');
  renderTodayTasks();
}

// Plan screen
function renderPlanScreen() {
  document.getElementById('planAppsProgress').textContent = state.completedThisWeek.apps;
  document.getElementById('planAppsTarget').textContent = state.targets.apps;
  document.getElementById('planAppsBar').value = state.completedThisWeek.apps;
  document.getElementById('planAppsBar').max = state.targets.apps;
  
  document.getElementById('planNetProgress').textContent = state.completedThisWeek.networking;
  document.getElementById('planNetTarget').textContent = state.targets.networking;
  document.getElementById('planNetBar').value = state.completedThisWeek.networking;
  document.getElementById('planNetBar').max = state.targets.networking;
  
  document.getElementById('planEventsProgress').textContent = state.completedThisWeek.events;
  document.getElementById('planEventsTarget').textContent = state.targets.events;
  
  const appsList = document.getElementById('appsList');
  if (state.applications.length === 0) {
    appsList.innerHTML = '<div class="empty-state"><div class="empty-state-emoji">💼</div><p>No applications yet</p></div>';
  } else {
    appsList.innerHTML = state.applications.map(app => `
      <div class="list-item">
        <div style="flex: 1;">
          <div class="list-item-title">
            ${app.company} - ${app.role}
            <span class="badge ${app.status}">${app.status}</span>
          </div>
          <div class="list-item-meta">
            ${app.deadline ? `Deadline: ${formatDate(app.deadline)}` : 'No deadline'}
            ${app.url ? ` • <a href="${app.url}" target="_blank" style="color: var(--accent);">View posting</a>` : ''}
          </div>
          ${app.notes ? `<div style="margin-top: 8px; font-size: 14px;">${app.notes}</div>` : ''}
        </div>
        <div class="item-actions">
          <button class="icon-btn" onclick="deleteApp('${app.id}')" title="Delete">🗑️</button>
          <button class="icon-btn" onclick="editApplication('${app.id}')" title="Edit">✏️</button>
        </div>
      </div>
    `).join('');
  }
  
  const contactsList = document.getElementById('contactsList');
  if (state.contacts.length === 0) {
    contactsList.innerHTML = '<div class="empty-state"><div class="empty-state-emoji">🤝</div><p>No contacts yet</p></div>';
  } else {
    contactsList.innerHTML = state.contacts.map(contact => `
      <div class="list-item">
        <div style="flex: 1;">
          <div class="list-item-title">
            ${contact.name}
            ${contact.status ? `<span class="badge ${contact.status}">${contact.status}</span>` : ''}
          </div>
          <div class="list-item-meta">
            ${contact.relationship}${contact.company ? ` • ${contact.company}` : ''}
            ${contact.lastContact ? ` • Last contact: ${formatDate(contact.lastContact)}` : ''}
          </div>
          ${contact.notes ? `<div style="margin-top: 8px; font-size: 14px;">${contact.notes}</div>` : ''}
        </div>
        <div class="item-actions">
          <button class="icon-btn" onclick="deleteContact('${contact.id}')" title="Delete">🗑️</button>
          <button class="icon-btn" onclick="editContact('${contact.id}')" title="Edit">✏️</button>
        </div>
      </div>
    `).join('');
  }
  
  const eventsList = document.getElementById('eventsList');
  if (state.events.length === 0) {
    eventsList.innerHTML = '<div class="empty-state"><div class="empty-state-emoji">📅</div><p>No events scheduled</p></div>';
  } else {
    eventsList.innerHTML = state.events.map(event => `
      <div class="list-item">
        <div style="flex: 1;">
          <div class="list-item-title">
            ${event.name}
            ${event.attended ? '<span class="badge ready">attended</span>' : ''}
          </div>
          <div class="list-item-meta">
            ${formatDate(event.date)} • ${event.duration} min • ${event.type}
          </div>
          ${event.notes ? `<div style="margin-top: 8px; font-size: 14px;">${event.notes}</div>` : ''}
          ${event.calendarUrl ? `<div style="margin-top: 6px; font-size: 12px;"><a href="${event.calendarUrl}" target="_blank" style="color: var(--accent);">Open calendar</a></div>` : ''}
        </div>
        <div class="item-actions">
          <button class="icon-btn" onclick="deleteEvent('${event.id}')" title="Delete">🗑️</button>
          <button class="icon-btn" onclick="editEvent('${event.id}')" title="Edit">✏️</button>
        </div>
      </div>
    `).join('');
  }
}

function deleteApp(appId) {
  if (!confirm('Delete this application? This will also remove related tasks.')) return;
  
  state.applications = state.applications.filter(a => a.id !== appId);
  
  Object.keys(state.dailyTasks).forEach(day => {
    state.dailyTasks[day] = state.dailyTasks[day].filter(t => t.refId !== appId);
  });
  
  saveToFirebase();
  renderPlanScreen();
  renderTodayTasks();
}

function deleteContact(contactId) {
  if (!confirm('Delete this contact? This will also remove related tasks.')) return;
  
  state.contacts = state.contacts.filter(c => c.id !== contactId);
  
  Object.keys(state.dailyTasks).forEach(day => {
    state.dailyTasks[day] = state.dailyTasks[day].filter(t => t.refId !== contactId);
  });
  
  saveToFirebase();
  renderPlanScreen();
  renderTodayTasks();
}

function deleteEvent(eventId) {
  if (!confirm('Delete this event? This will also remove related tasks.')) return;
  
  state.events = state.events.filter(e => e.id !== eventId);
  
  Object.keys(state.dailyTasks).forEach(day => {
    state.dailyTasks[day] = state.dailyTasks[day].filter(t => t.refId !== eventId);
  });
  
  saveToFirebase();
  renderPlanScreen();
  renderTodayTasks();
}

// Progress screen
function renderProgress() {
  const today = getTodayISO();
  const dayOfWeek = getDaysDifference(today, state.weekStart);
  
  // Aggregate weekly time
  let weekOptTime = 0;
  let weekExecTime = 0;
  for (let i = 0; i < 7; i++) {
    const day = addDays(state.weekStart, i);
    const tracking = state.dailyTimeTracking[day] || { optimization: 0, execution: 0 };
    weekOptTime += tracking.optimization;
    weekExecTime += tracking.execution;
  }
  
  // Any event scheduled this week?
  let anyEventThisWeek = false;
  for (let i = 0; i < 7; i++) {
    const day = addDays(state.weekStart, i);
    if ((state.events || []).some(e => e.date === day)) { anyEventThisWeek = true; break; }
  }
  
  // Build condensed dashboard
  const dash = `
    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; margin-bottom: 20px;">
      <div style="background: var(--panel); border: 1px solid var(--line); border-radius: 12px; padding: 16px;">
        <div style="display:flex; justify-content: space-between; align-items:center;">
          <div style="color: var(--muted);">Week</div>
          <div style="font-weight:600;">Day ${dayOfWeek + 1} of 7</div>
        </div>
        <div style="display:flex; gap:8px; margin-top:8px;" id="progressWeekDots"></div>
      </div>
      <div style="background: var(--panel); border: 1px solid var(--line); border-radius: 12px; padding: 16px; text-align:center;">
        <div style="font-size: 32px;">🔥</div>
        <div style="font-size: 28px; font-weight: 700;" id="progressStreakCount">${state.streaks.current || 0}</div>
        <div style="font-size: 12px; color: var(--muted);">day streak (best ${state.streaks.longest || 0})</div>
      </div>
      <div style="background: var(--panel); border: 1px solid var(--line); border-radius: 12px; padding: 16px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <span>Applications</span>
          <span id="progressAppsStatus">${state.completedThisWeek.apps}/${state.targets.apps}</span>
        </div>
        <progress id="progressAppsBar" value="${state.completedThisWeek.apps}" max="${state.targets.apps}" style="width:100%"></progress>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
          <span>Networking</span>
          <span id="progressNetStatus">${state.completedThisWeek.networking}/${state.targets.networking}</span>
        </div>
        <progress id="progressNetBar" value="${state.completedThisWeek.networking}" max="${state.targets.networking}" style="width:100%"></progress>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
          <span>Events</span>
          <span id="progressEventsStatus">${state.completedThisWeek.events}/${state.targets.events}</span>
        </div>
        <progress id="progressEventsBar" value="${state.completedThisWeek.events}" max="${state.targets.events}" style="width:100%"></progress>
      </div>
      <div style="background: var(--panel); border: 1px solid var(--line); border-radius: 12px; padding: 16px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <span>Optimization</span>
          <span id="progressWeekOptTime">${weekOptTime} min</span>
        </div>
        <div style="font-size: 12px; color: var(--muted);">Resume tweaking, strategy</div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px;">
          <span>Execution</span>
          <span id="progressWeekExecTime">${weekExecTime} min</span>
        </div>
        <div style="font-size: 12px; color: var(--muted);">Applications, networking, events</div>
      </div>
    </div>
  `;
  const dashRoot = document.getElementById('progressDashboard');
  if (dashRoot) dashRoot.innerHTML = dash;
  
  // Week dots
  const dotsHtml = Array.from({length: 7}, (_, i) => {
    const isPast = i < dayOfWeek;
    const isToday = i === dayOfWeek;
    const color = isPast ? 'var(--ok)' : isToday ? 'var(--accent)' : 'var(--line)';
    return `<div style=\"flex: 1; height: 8px; background: ${color}; border-radius: 4px;\"></div>`;
  }).join('');
  const dotsEl = document.getElementById('progressWeekDots');
  if (dotsEl) dotsEl.innerHTML = dotsHtml;
  
  // Events denominator color
  const eventsStatusEl = document.getElementById('progressEventsStatus');
  if (eventsStatusEl) {
    const parts = eventsStatusEl.textContent.split('/');
    const numerator = parts[0];
    const denom = parts[1];
    eventsStatusEl.innerHTML = `${numerator}/<span style=\"color:${anyEventThisWeek ? 'var(--ok)' : 'var(--bad)'}\">${denom}</span>`;
  }
  
  // History list
  const historyEl = document.getElementById('applicationHistory');
  if (historyEl) {
    if (state.applications.length === 0) {
      historyEl.innerHTML = '<p style=\"color: var(--muted); text-align: center;\">No applications yet</p>';
    } else {
      historyEl.innerHTML = state.applications.map(app => {
        let totalTime = 0;
        Object.values(state.dailyTasks).forEach(dayTasks => {
          dayTasks.forEach(t => {
            if (t.refId === app.id && t.completed) {
              totalTime += t.actualTime || 0;
            }
          });
        });
        return `
          <div class=\"list-item\">
            <div>
              <div style=\"font-weight: 600; margin-bottom: 4px;\">${app.company} - ${app.role}</div>
              <div style=\"font-size: 14px; color: var(--muted);\">${totalTime > 0 ? `${totalTime} min invested` : 'Not started'} • ${app.status}</div>
            </div>
          </div>
        `;
      }).join('');
    }
  }
  
  // Render Analytics section
  renderAnalytics();
}

function renderAnalytics() {
  const today = getTodayISO();
  const currentDay = state.timeBlocking?.currentDay;
  
  // Daily Focus Summary
  renderDailyFocusSummary(currentDay, today);
  
  // Weekly Overview
  renderWeeklyOverview(today);
  
  // Badges
  renderBadges();
  
  // Insights
  renderInsights(currentDay, today);
}

function renderDailyFocusSummary(currentDay, today) {
  const card = document.getElementById('dailyFocusCard');
  if (!card) return;
  
  if (!currentDay || currentDay.date !== today) {
    card.innerHTML = `
      <div style="color: var(--muted); font-size: 14px; margin-bottom: 8px;">No focus session today</div>
      <div style="font-size: 12px; color: var(--muted);">Start a focus session to see your analytics</div>
    `;
    return;
  }
  
  const { goalBlocks, completedBlocks, startTime, activeChunk } = currentDay;
  const onTaskTime = activeChunk?.onTaskTime || 0;
  const offTaskTime = activeChunk?.offTaskTime || 0;
  const totalTime = onTaskTime + offTaskTime;
  const onTaskPct = totalTime > 0 ? Math.round((onTaskTime / totalTime) * 100) : 0;
  
  card.innerHTML = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 16px; margin-bottom: 16px;">
      <div style="text-align: center;">
        <div class="mono" style="font-size: 24px; font-weight: 600; color: var(--accent);">${completedBlocks}</div>
        <div style="font-size: 12px; color: var(--muted);">Blocks</div>
        <div style="font-size: 10px; color: var(--muted);">of ${goalBlocks}</div>
      </div>
      <div style="text-align: center;">
        <div class="mono" style="font-size: 24px; font-weight: 600; color: var(--ok);">${onTaskPct}%</div>
        <div style="font-size: 12px; color: var(--muted);">On-task</div>
        <div class="mono" style="font-size: 10px; color: var(--muted);">${Math.floor(onTaskTime/60)}h ${onTaskTime%60}m</div>
      </div>
      <div style="text-align: center;">
        <div class="mono" style="font-size: 24px; font-weight: 600; color: var(--warn);">${Math.floor(offTaskTime/60)}h ${offTaskTime%60}m</div>
        <div style="font-size: 12px; color: var(--muted);">Off-task</div>
        <div style="font-size: 10px; color: var(--muted);">Started ${startTime}</div>
      </div>
    </div>
    <div style="display: flex; gap: 4px; justify-content: center; flex-wrap: wrap;">
      ${Array.from({length: goalBlocks}, (_, i) => 
        `<div class="focus-block" style="width: 16px; height: 16px; ${i < completedBlocks ? 'background: var(--ok); border-color: var(--ok);' : ''}"></div>`
      ).join('')}
    </div>
  `;
}

function renderWeeklyOverview(today) {
  const grid = document.getElementById('weeklyFocusGrid');
  const totalBlocks = document.getElementById('weeklyTotalBlocks');
  const onTaskPct = document.getElementById('weeklyOnTaskPct');
  const streak = document.getElementById('weeklyStreak');
  
  if (!grid) return;
  
  // Calculate week data
  let weekTotalBlocks = 0;
  let weekOnTaskTime = 0;
  let weekTotalTime = 0;
  let currentStreak = 0;
  
  const weekDays = [];
  for (let i = 0; i < 7; i++) {
    const day = addDays(state.weekStart, i);
    const dayData = state.timeBlocking?.history?.[day] || {};
    const blocks = dayData.completedBlocks || 0;
    const onTask = dayData.totalOnTaskTime || 0;
    const total = dayData.totalTime || 0;
    
    weekTotalBlocks += blocks;
    weekOnTaskTime += onTask;
    weekTotalTime += total;
    
    if (blocks > 0) {
      currentStreak++;
    } else if (day <= today) {
      currentStreak = 0;
    }
    
    weekDays.push({
      date: day,
      blocks,
      onTask,
      total,
      isToday: day === today
    });
  }
  
  // Render week grid
  grid.innerHTML = weekDays.map((day, i) => {
    const dayName = ['S', 'M', 'T', 'W', 'T', 'F', 'S'][i];
    const isPast = day.date < today;
    const isToday = day.isToday;
    const hasBlocks = day.blocks > 0;
    
    let bgColor = 'rgba(0,0,0,0.1)';
    if (hasBlocks) bgColor = 'var(--ok)';
    else if (isPast) bgColor = 'var(--bad)';
    else if (isToday) bgColor = 'var(--accent)';
    
    return `
      <div style="text-align: center; padding: 8px; background: ${bgColor}; border-radius: 8px; opacity: ${isPast && !hasBlocks ? 0.5 : 1};">
        <div style="font-size: 12px; font-weight: 600; margin-bottom: 4px;">${dayName}</div>
        <div style="font-size: 16px; font-weight: 700;">${day.blocks}</div>
        <div style="font-size: 10px; color: var(--muted);">blocks</div>
      </div>
    `;
  }).join('');
  
  // Update stats
  if (totalBlocks) totalBlocks.textContent = weekTotalBlocks;
  if (onTaskPct) onTaskPct.textContent = weekTotalTime > 0 ? Math.round((weekOnTaskTime / weekTotalTime) * 100) + '%' : '0%';
  if (streak) streak.textContent = currentStreak;
}

function renderInsights(currentDay, today) {
  const title = document.getElementById('insightTitle');
  const subtitle = document.getElementById('insightSubtitle');
  const text = document.getElementById('insightText');
  
  if (!title || !subtitle || !text) return;
  
  if (!currentDay || currentDay.date !== today) {
    title.textContent = 'Ready to Focus';
    subtitle.textContent = 'Start your first focus session to unlock insights';
    text.textContent = 'Your focus analytics will appear here once you start tracking your work sessions.';
    return;
  }
  
  const { goalBlocks, completedBlocks, activeChunk } = currentDay;
  const onTaskTime = activeChunk?.onTaskTime || 0;
  const offTaskTime = activeChunk?.offTaskTime || 0;
  const totalTime = onTaskTime + offTaskTime;
  const onTaskPct = totalTime > 0 ? Math.round((onTaskTime / totalTime) * 100) : 0;
  
  // Generate insights based on current progress
  let insight = '';
  let emoji = '🎯';
  
  if (completedBlocks === 0) {
    insight = 'Ready to start your focus journey! Set a goal and begin your first chunk.';
    emoji = '🚀';
  } else if (completedBlocks < goalBlocks / 2) {
    insight = `Great start! You've completed ${completedBlocks} of ${goalBlocks} blocks. Keep the momentum going!`;
    emoji = '💪';
  } else if (completedBlocks < goalBlocks) {
    insight = `You're ${Math.round((completedBlocks / goalBlocks) * 100)}% to your goal! ${goalBlocks - completedBlocks} more blocks to go.`;
    emoji = '🔥';
  } else {
    insight = `Amazing! You've crushed your daily goal of ${goalBlocks} blocks! 🎉`;
    emoji = '🏆';
  }
  
  if (onTaskPct >= 90) {
    insight += ' Your focus is laser-sharp today!';
  } else if (onTaskPct < 70 && totalTime > 30) {
    insight += ' Try to minimize distractions to boost your on-task percentage.';
  }
  
  title.textContent = insight.split('!')[0] + '!';
  subtitle.textContent = `${completedBlocks}/${goalBlocks} blocks • ${onTaskPct}% on-task`;
  text.textContent = insight;
  
  // Update emoji
  const emojiEl = document.querySelector('#insightsCard .font-size-24px');
  if (emojiEl) emojiEl.textContent = emoji;
}

function renderBadges() {
  const badgesGrid = document.getElementById('badgesGrid');
  const currentStreak = document.getElementById('currentStreak');
  const longestStreak = document.getElementById('longestStreak');
  const totalBadges = document.getElementById('totalBadges');
  
  if (!badgesGrid) return;
  
  const achievements = state.timeBlocking?.achievements;
  const earnedBadges = achievements?.badges || [];
  const streaks = achievements?.streaks || {};
  
  // Render earned badges
  if (earnedBadges.length === 0) {
    badgesGrid.innerHTML = `
      <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--muted);">
        <div style="font-size: 32px; margin-bottom: 8px;">🏆</div>
        <div>No badges yet</div>
        <div style="font-size: 12px; margin-top: 4px;">Start focusing to earn achievements!</div>
      </div>
    `;
  } else {
    badgesGrid.innerHTML = earnedBadges.map(badge => `
      <div style="text-align: center; padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
        <div style="font-size: 24px; margin-bottom: 4px;">${badge.icon}</div>
        <div style="font-size: 11px; font-weight: 600; color: var(--text); margin-bottom: 2px;">${badge.name}</div>
        <div style="font-size: 9px; color: var(--muted);">${badge.description}</div>
      </div>
    `).join('');
  }
  
  // Update streak stats
  if (currentStreak) currentStreak.textContent = streaks.currentWorkStreak || 0;
  if (longestStreak) longestStreak.textContent = streaks.longestWork || 0;
  if (totalBadges) totalBadges.textContent = earnedBadges.length;
}

function saveDailyDataToHistory() {
  if (!state.timeBlocking?.currentDay) return;
  
  const currentDay = state.timeBlocking.currentDay;
  const today = getTodayISO();
  
  // Calculate total times from all chunks
  let totalOnTaskTime = 0;
  let totalOffTaskTime = 0;
  let totalTime = 0;
  
  // Add active chunk times
  if (currentDay.activeChunk) {
    totalOnTaskTime += currentDay.activeChunk.onTaskTime || 0;
    totalOffTaskTime += currentDay.activeChunk.offTaskTime || 0;
  }
  
  // Add completed chunks times
  currentDay.chunks.forEach(chunk => {
    totalOnTaskTime += chunk.onTaskTime || 0;
    totalOffTaskTime += chunk.offTaskTime || 0;
  });
  
  totalTime = totalOnTaskTime + totalOffTaskTime;
  
  // Save to history
  if (!state.timeBlocking.history) {
    state.timeBlocking.history = {};
  }
  
  state.timeBlocking.history[today] = {
    date: today,
    goalBlocks: currentDay.goalBlocks,
    completedBlocks: currentDay.completedBlocks,
    startTime: currentDay.startTime,
    endTime: new Date().toLocaleTimeString('en-US', { 
      hour: 'numeric', 
      minute: '2-digit',
      hour12: true,
      timeZone: 'America/Los_Angeles'
    }),
    totalOnTaskTime,
    totalOffTaskTime,
    totalTime,
    chunks: currentDay.chunks,
    sessions: currentDay.sessions || []
  };
  
  saveToFirebase();
}

function startNewDay() {
  const today = getTodayISO();
  
  // Save previous day to history if it exists
  if (state.timeBlocking?.currentDay && state.timeBlocking.currentDay.date !== today) {
    saveDailyDataToHistory();
  }
  
  // Initialize new day
  const goalBlocks = parseInt(document.getElementById('focusGoalInput').value) || 12;
  const now = new Date();
  const startTime = now.toLocaleTimeString('en-US', { 
    hour: 'numeric', 
    minute: '2-digit',
    hour12: true,
    timeZone: 'America/Los_Angeles'
  });
  
  state.timeBlocking = {
    ...state.timeBlocking,
    currentDay: {
      date: today,
      startTime,
      endTime: null,
      goalBlocks,
      completedBlocks: 0,
      activeChunk: null,
      chunks: [],
      currentMode: 'on-task',
      modeStartTime: now.toISOString(),
      sessions: []
    },
    history: state.timeBlocking?.history || {}
  };
  
  saveToFirebase();
  renderFocusPanel();
}

// Gamification System
const BADGES = {
  // Week badges
  BRONZE_WEEK: { id: 'bronze_week', name: 'Bronze Week', description: 'Complete 10+ blocks in a week', icon: '🥉', requirement: 10, type: 'week' },
  SILVER_WEEK: { id: 'silver_week', name: 'Silver Week', description: 'Complete 20+ blocks in a week', icon: '🥈', requirement: 20, type: 'week' },
  GOLD_WEEK: { id: 'gold_week', name: 'Gold Week', description: 'Complete 30+ blocks in a week', icon: '🥇', requirement: 30, type: 'week' },
  
  // Streak badges
  THREE_DAY_STREAK: { id: 'three_day_streak', name: 'Getting Started', description: '3-day work streak', icon: '🔥', requirement: 3, type: 'streak' },
  SEVEN_DAY_STREAK: { id: 'seven_day_streak', name: 'Week Warrior', description: '7-day work streak', icon: '⚡', requirement: 7, type: 'streak' },
  THIRTY_DAY_STREAK: { id: 'thirty_day_streak', name: 'Month Master', description: '30-day work streak', icon: '💎', requirement: 30, type: 'streak' },
  
  // Focus badges
  FOCUSED_MIND: { id: 'focused_mind', name: 'Focused Mind', description: '95%+ on-task for a day', icon: '🎯', requirement: 95, type: 'focus' },
  LASER_FOCUS: { id: 'laser_focus', name: 'Laser Focus', description: '98%+ on-task for a day', icon: '⚡', requirement: 98, type: 'focus' },
  PERFECT_DAY: { id: 'perfect_day', name: 'Perfect Day', description: 'Complete daily goal', icon: '✨', requirement: 100, type: 'goal' },
  
  // Milestone badges
  FIRST_SESSION: { id: 'first_session', name: 'First Steps', description: 'Complete your first focus session', icon: '👶', requirement: 1, type: 'milestone' },
  HUNDRED_BLOCKS: { id: 'hundred_blocks', name: 'Centurion', description: 'Complete 100 total blocks', icon: '💯', requirement: 100, type: 'milestone' },
  FIVE_HUNDRED_BLOCKS: { id: 'five_hundred_blocks', name: 'Block Master', description: 'Complete 500 total blocks', icon: '🏆', requirement: 500, type: 'milestone' }
};

function checkAchievements() {
  if (!state.timeBlocking?.achievements) return;
  
  const achievements = state.timeBlocking.achievements;
  const newBadges = [];
  
  // Calculate current stats
  const stats = calculateAchievementStats();
  
  // Check week badges
  if (stats.weeklyBlocks >= 10 && !hasBadge('bronze_week')) {
    newBadges.push(BADGES.BRONZE_WEEK);
  }
  if (stats.weeklyBlocks >= 20 && !hasBadge('silver_week')) {
    newBadges.push(BADGES.SILVER_WEEK);
  }
  if (stats.weeklyBlocks >= 30 && !hasBadge('gold_week')) {
    newBadges.push(BADGES.GOLD_WEEK);
  }
  
  // Check streak badges
  if (stats.currentWorkStreak >= 3 && !hasBadge('three_day_streak')) {
    newBadges.push(BADGES.THREE_DAY_STREAK);
  }
  if (stats.currentWorkStreak >= 7 && !hasBadge('seven_day_streak')) {
    newBadges.push(BADGES.SEVEN_DAY_STREAK);
  }
  if (stats.currentWorkStreak >= 30 && !hasBadge('thirty_day_streak')) {
    newBadges.push(BADGES.THIRTY_DAY_STREAK);
  }
  
  // Check focus badges
  if (stats.todayOnTaskPct >= 95 && !hasBadge('focused_mind')) {
    newBadges.push(BADGES.FOCUSED_MIND);
  }
  if (stats.todayOnTaskPct >= 98 && !hasBadge('laser_focus')) {
    newBadges.push(BADGES.LASER_FOCUS);
  }
  if (stats.todayGoalComplete && !hasBadge('perfect_day')) {
    newBadges.push(BADGES.PERFECT_DAY);
  }
  
  // Check milestone badges
  if (stats.totalSessions >= 1 && !hasBadge('first_session')) {
    newBadges.push(BADGES.FIRST_SESSION);
  }
  if (stats.totalBlocks >= 100 && !hasBadge('hundred_blocks')) {
    newBadges.push(BADGES.HUNDRED_BLOCKS);
  }
  if (stats.totalBlocks >= 500 && !hasBadge('five_hundred_blocks')) {
    newBadges.push(BADGES.FIVE_HUNDRED_BLOCKS);
  }
  
  // Award new badges
  newBadges.forEach(badge => {
    achievements.badges.push({
      ...badge,
      earnedAt: new Date().toISOString(),
      earnedOn: getTodayISO()
    });
    showBadgeCelebration(badge);
  });
  
  // Update streaks
  updateStreaks(stats);
  
  if (newBadges.length > 0) {
    saveToFirebase();
  }
}

function hasBadge(badgeId) {
  return state.timeBlocking?.achievements?.badges?.some(b => b.id === badgeId) || false;
}

function calculateAchievementStats() {
  const today = getTodayISO();
  const currentDay = state.timeBlocking?.currentDay;
  const history = state.timeBlocking?.history || {};
  
  // Calculate weekly blocks
  let weeklyBlocks = 0;
  for (let i = 0; i < 7; i++) {
    const day = addDays(state.weekStart, i);
    const dayData = history[day];
    if (dayData) {
      weeklyBlocks += dayData.completedBlocks || 0;
    }
  }
  
  // Calculate today's stats
  const todayOnTaskPct = currentDay ? calculateTodayOnTaskPct(currentDay) : 0;
  const todayGoalComplete = currentDay ? currentDay.completedBlocks >= currentDay.goalBlocks : false;
  
  // Calculate total stats
  let totalBlocks = 0;
  let totalSessions = 0;
  Object.values(history).forEach(day => {
    totalBlocks += day.completedBlocks || 0;
    totalSessions += day.chunks?.length || 0;
  });
  
  // Calculate work streak
  let currentWorkStreak = 0;
  let checkDate = today;
  while (history[checkDate] && (history[checkDate].completedBlocks || 0) > 0) {
    currentWorkStreak++;
    checkDate = addDays(checkDate, -1);
  }
  
  return {
    weeklyBlocks,
    todayOnTaskPct,
    todayGoalComplete,
    totalBlocks,
    totalSessions,
    currentWorkStreak
  };
}

function calculateTodayOnTaskPct(currentDay) {
  const onTaskTime = currentDay.activeChunk?.onTaskTime || 0;
  const offTaskTime = currentDay.activeChunk?.offTaskTime || 0;
  const totalTime = onTaskTime + offTaskTime;
  return totalTime > 0 ? Math.round((onTaskTime / totalTime) * 100) : 0;
}

function updateStreaks(stats) {
  const achievements = state.timeBlocking.achievements;
  
  // Update current streaks
  achievements.streaks.currentWorkStreak = stats.currentWorkStreak;
  
  // Update longest streaks
  if (stats.currentWorkStreak > achievements.streaks.longestWork) {
    achievements.streaks.longestWork = stats.currentWorkStreak;
  }
  
  // Update total stats
  achievements.stats.totalBlocks = stats.totalBlocks;
  achievements.stats.totalSessions = stats.totalSessions;
  if (stats.todayGoalComplete) {
    achievements.stats.perfectDays++;
  }
}

function showBadgeCelebration(badge) {
  // Create celebration overlay
  const overlay = document.createElement('div');
  overlay.className = 'celebration-overlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeUp 0.5s ease-out;
  `;
  
  // Create badge popup
  const popup = document.createElement('div');
  popup.style.cssText = `
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    box-shadow: var(--shadow-lift);
    animation: celebrationPulse 2s ease-in-out;
    max-width: 400px;
    margin: 20px;
  `;
  
  popup.innerHTML = `
    <div style="font-size: 64px; margin-bottom: 16px; animation: sparkle 1s ease-in-out infinite;">${badge.icon}</div>
    <h2 style="margin: 0 0 8px 0; color: var(--accent); font-size: 24px;">${badge.name}</h2>
    <p style="margin: 0 0 20px 0; color: var(--muted); font-size: 16px;">${badge.description}</p>
    <button onclick="this.parentElement.parentElement.remove()" class="modern-button primary" style="padding: 12px 24px;">
      Awesome! 🎉
    </button>
  `;
  
  overlay.appendChild(popup);
  document.body.appendChild(overlay);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (overlay.parentElement) {
      overlay.remove();
    }
  }, 5000);
  
  // Add confetti
  createConfetti();
}

function createConfetti() {
  const colors = ['#5ad0ff', '#79dd94', '#ffbe5a', '#ff6b6b', '#d97706'];
  const confettiCount = 50;
  
  for (let i = 0; i < confettiCount; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti-piece';
    confetti.style.cssText = `
      position: fixed;
      width: 10px;
      height: 10px;
      background: ${colors[Math.floor(Math.random() * colors.length)]};
      left: ${Math.random() * 100}vw;
      top: -10px;
      animation: confetti 3s ease-out forwards;
      z-index: 9999;
    `;
    document.body.appendChild(confetti);
    
    // Remove after animation
    setTimeout(() => confetti.remove(), 3000);
  }
}

function isOnTrack() {
  const today = getTodayISO();
  const dayOfWeek = getDaysDifference(today, state.weekStart);
  const daysLeft = 7 - dayOfWeek;
  
  const appsNeeded = state.targets.apps - state.completedThisWeek.apps;
  const netNeeded = state.targets.networking - state.completedThisWeek.networking;
  
  if (appsNeeded <= 0 && netNeeded <= 0) {
    return { status: 'ahead', message: '' };
  }
  
  const appsDailyNeeded = Math.ceil(appsNeeded / daysLeft);
  const netDailyNeeded = Math.ceil(netNeeded / daysLeft);
  
  if (appsDailyNeeded <= 3 && netDailyNeeded <= 2) {
    return { status: 'on_track', message: '' };
  }
  
  return { 
    status: 'behind', 
    message: `Need ${appsDailyNeeded} apps/day to catch up` 
  };
}

// App initialization
async function initializeApp() {
  console.log('Initializing Career Chute...');
  
  // Show loading state
  updateSyncStatus('syncing', 'Starting...');
  
  // Global timeout - if nothing happens in 10 seconds, go offline
  const globalTimeout = setTimeout(() => {
    console.warn('App initialization timeout - forcing offline mode');
    updateSyncStatus('error', 'Offline');
    loadFromLocalStorage();
  }, 10000);
  
  try {
    // Try to initialize Firebase with timeout
    const firebaseReady = await initializeFirebase();
    clearTimeout(globalTimeout);
    
    if (firebaseReady) {
      console.log('Firebase ready, loading from cloud...');
      loadFromFirebase();
    } else {
      console.log('Firebase unavailable, loading from local storage...');
      updateSyncStatus('error', 'Offline');
      loadFromLocalStorage();
    }
    
    // Initialize Gmail API after Firebase loads
    if (state.gmail && state.gmail.clientId) {
      initGoogleAPI().catch(error => {
        console.warn('Gmail API initialization failed:', error);
      });
    }
  } catch (error) {
    clearTimeout(globalTimeout);
    console.error('App initialization error:', error);
    updateSyncStatus('error', 'Offline');
    loadFromLocalStorage();
  }
}

// Start the app when page loads
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, starting app...');
  
  // Emergency fallback - if app doesn't load in 5 seconds, force offline
  setTimeout(() => {
    const syncText = document.getElementById('syncText');
    if (syncText && syncText.textContent === 'Loading...') {
      console.warn('Emergency fallback triggered - forcing offline mode');
      updateSyncStatus('error', 'Offline');
      loadFromLocalStorage();
    }
  }, 5000);
  
  initializeApp();
});

// Cleanup timers when page unloads
window.addEventListener('beforeunload', function() {
  if (chunkTimerInterval) {
    clearInterval(chunkTimerInterval);
  }
});

// Also start if DOM is already loaded
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeApp);
} else {
  initializeApp();
}

// Modal and UI functions
function showAddTaskModal() {
  document.getElementById('addTaskModal').classList.add('active');
  updateTaskModalForType();
}

function showAddAppModal() {
  // Clear form fields
  document.getElementById('newAppCompany').value = '';
  document.getElementById('newAppRole').value = '';
  document.getElementById('newAppUrl').value = '';
  document.getElementById('newAppDeadline').value = '';
  document.getElementById('newAppNotes').value = '';
  
  document.getElementById('addAppModal').classList.add('active');
}

function showAddContactModal() {
  // Clear form fields
  document.getElementById('newContactName').value = '';
  document.getElementById('newContactRel').value = 'Friend/Ally';
  document.getElementById('newContactCompany').value = '';
  document.getElementById('newContactNotes').value = '';
  
  document.getElementById('addContactModal').classList.add('active');
}

function showAddEventModal() {
  // Clear form fields
  document.getElementById('newEventName').value = '';
  document.getElementById('newEventDate').value = '';
  document.getElementById('newEventDuration').value = '120';
  document.getElementById('newEventType').value = 'fair';
  document.getElementById('newEventNotes').value = '';
  
  document.getElementById('addEventModal').classList.add('active');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
}

function updateTaskModalForType() {
  const type = document.getElementById('newTaskType').value;
  const selectSection = document.getElementById('taskSelectSection');
  const quickSection = document.getElementById('quickAddSection');
  const refSelect = document.getElementById('newTaskRef');
  const toggle = document.getElementById('quickAddToggle');
  
  // Clear existing options
  refSelect.innerHTML = '<option value="">-- Select --</option>';
  
  if (type === 'application') {
    state.applications.forEach(app => {
      const option = document.createElement('option');
      option.value = app.id;
      option.textContent = `${app.company} - ${app.role}`;
      refSelect.appendChild(option);
    });
    selectSection.style.display = 'block';
  } else if (type === 'networking') {
    state.contacts.forEach(contact => {
      const option = document.createElement('option');
      option.value = contact.id;
      option.textContent = contact.name;
      refSelect.appendChild(option);
    });
    selectSection.style.display = 'block';
  } else if (type === 'event') {
    state.events.forEach(event => {
      const option = document.createElement('option');
      option.value = event.id;
      option.textContent = event.name;
      refSelect.appendChild(option);
    });
    selectSection.style.display = 'block';
  } else {
    selectSection.style.display = 'none';
  }
  
  quickSection.style.display = 'none';
  if (type === 'application') toggle.textContent = '+ Quick add application';
  else if (type === 'networking') toggle.textContent = '+ Quick add contact';
  else if (type === 'event') toggle.textContent = '+ Quick add event';
}

function toggleQuickAdd() {
  const quickSection = document.getElementById('quickAddSection');
  const toggle = document.getElementById('quickAddToggle');
  
  if (quickSection.style.display === 'none') {
    const type = document.getElementById('newTaskType').value;
    let html = '';
    
    if (type === 'application') {
      html = `
        <div class="form-group">
          <label>Company Name</label>
          <input type="text" id="quickAppCompany" placeholder="Acme Corp">
        </div>
        <div class="form-group">
          <label>Job Title</label>
          <input type="text" id="quickAppRole" placeholder="Product Manager">
        </div>
        <div class="form-group">
          <label>Job URL</label>
          <input type="url" id="quickAppUrl" placeholder="https://...">
        </div>
      `;
    } else if (type === 'networking') {
      html = `
        <div class="form-group">
          <label>Contact Name</label>
          <input type="text" id="quickContactName" placeholder="John Smith">
        </div>
        <div class="form-group">
          <label>Contact URL (LinkedIn, website)</label>
          <input type="url" id="quickContactUrl" placeholder="https://linkedin.com/in/...">
        </div>
      `;
    } else if (type === 'event') {
      html = `
        <div class="form-group">
          <label>Event Name</label>
          <input type="text" id="quickEventName" placeholder="Career Fair">
        </div>
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="quickEventDate">
        </div>
        <div class="form-group">
          <label>Duration (minutes)</label>
          <input type="number" id="quickEventDuration" value="120">
        </div>
        <div class="form-group">
          <label>Type</label>
          <select id="quickEventType">
            <option value="fair">Career Fair</option>
            <option value="workshop">Workshop</option>
            <option value="info_session">Info Session</option>
            <option value="networking">Networking Event</option>
            <option value="interview">Interview</option>
          </select>
        </div>
        <div class="form-group">
          <label>Calendar Link (optional)</label>
          <input type="url" id="quickEventCalendarUrl" placeholder="https://calendar.google.com/...">
        </div>
      `;
    }
    
    quickSection.innerHTML = html;
    quickSection.style.display = 'block';
    // Keep label static; user can cancel modal to exit
    if (type === 'application') toggle.textContent = '+ Quick add application';
    else if (type === 'networking') toggle.textContent = '+ Quick add contact';
    else if (type === 'event') toggle.textContent = '+ Quick add event';
  } else {
    quickSection.style.display = 'none';
    const type = document.getElementById('newTaskType').value;
    if (type === 'application') toggle.textContent = '+ Quick add application';
    else if (type === 'networking') toggle.textContent = '+ Quick add contact';
    else if (type === 'event') toggle.textContent = '+ Quick add event';
  }
}

function addTaskToToday() {
  const type = document.getElementById('newTaskType').value;
  const refId = document.getElementById('newTaskRef').value;
  const today = getTodayISO();
  
  if (!state.dailyTasks[today]) {
    state.dailyTasks[today] = [];
  }
  
  let task = {
    id: generateId(),
    type: type,
    completed: false,
    estimatedTime: type === 'tailoring' ? 40 : type === 'application' ? 20 : type === 'networking' ? 15 : 60,
    notes: ''
  };
  
  // Handle quick add
  const quickSection = document.getElementById('quickAddSection');
  if (quickSection.style.display !== 'none') {
    if (type === 'application') {
      const company = document.getElementById('quickAppCompany').value.trim();
      const role = document.getElementById('quickAppRole').value.trim();
      const url = document.getElementById('quickAppUrl').value.trim();
      if (!company || !role) {
        alert('Please fill in company and role');
        return;
      }
      
      // Create new application
      const app = {
        id: generateId(),
        company: company,
        role: role,
        status: 'queued',
        dateAdded: today,
        url: url,
        notes: ''
      };
      state.applications.push(app);
      task.refId = app.id;
      // Also auto-create tailoring task for today
      const tailoringTask = { id: generateId(), type: 'tailoring', refId: app.id, completed: false, estimatedTime: 40, notes: '' };
      state.dailyTasks[today].push(tailoringTask);
    } else if (type === 'networking') {
      const name = document.getElementById('quickContactName').value.trim();
      const contactUrl = document.getElementById('quickContactUrl').value.trim();
      if (!name) {
        alert('Please fill in contact name');
        return;
      }
      
      // Create new contact
      const contact = {
        id: generateId(),
        name: name,
        relationship: 'Professional Contact',
        company: '',
        notes: '',
        url: contactUrl
      };
      state.contacts.push(contact);
      task.refId = contact.id;
    } else if (type === 'event') {
      const name = document.getElementById('quickEventName').value.trim();
      if (!name) {
        alert('Please fill in event name');
        return;
      }
      
      // Create new event
      const event = {
        id: generateId(),
        name: name,
        date: document.getElementById('quickEventDate').value || today,
        duration: parseInt(document.getElementById('quickEventDuration').value || '120'),
        type: document.getElementById('quickEventType').value || 'networking',
        notes: '',
        calendarUrl: document.getElementById('quickEventCalendarUrl') ? document.getElementById('quickEventCalendarUrl').value.trim() : ''
      };
      state.events.push(event);
      task.refId = event.id;
    }
  } else if (refId) {
    task.refId = refId;
    // If adding application task, also create paired tailoring task
    if (type === 'application') {
      const tailoringTask = { id: generateId(), type: 'tailoring', refId: refId, completed: false, estimatedTime: 40, notes: '' };
      state.dailyTasks[today].push(tailoringTask);
    }
  } else {
    alert('Please select an item or use quick add');
    return;
  }

  // Prevent duplicate tasks for same ref on same day
  const duplicate = (state.dailyTasks[today] || []).some(t => t.type === task.type && t.refId === task.refId && !t.completed);
  if (duplicate) {
    alert('This task already exists for today.');
  } else {
    state.dailyTasks[today].push(task);
  }
  saveToFirebase();
  
  closeModal('addTaskModal');
  renderTodayTasks();
  renderPlanScreen();
}

// Edit/Delete helpers for queue and pipeline
function editQueueItem(taskId) {
  const today = getTodayISO();
  const task = (state.dailyTasks[today] || []).find(t => t.id === taskId);
  if (!task) return;
  // Open unified edit modal pre-filled like quick add
  openEditModalForTask(task);
}

function deleteQueueItem(taskId) {
  const today = getTodayISO();
  if (!state.dailyTasks[today]) return;
  if (!confirm('Remove this task from today?')) return;
  state.dailyTasks[today] = state.dailyTasks[today].filter(t => t.id !== taskId);
  saveToFirebase();
  renderTodayTasks();
}

function editApplication(appId) { const app = state.applications.find(a => a.id === appId); if (!app) return; openEditModal('application', app); }
function editContact(contactId) { const contact = state.contacts.find(c => c.id === contactId); if (!contact) return; openEditModal('networking', contact); }
function editEvent(eventId) { const event = state.events.find(e => e.id === eventId); if (!event) return; openEditModal('event', event); }

// Unified edit modal using existing add modals' layout
function openEditModalForTask(task) {
  if (task.type === 'application' || task.type === 'tailoring') {
    const app = state.applications.find(a => a.id === task.refId);
    if (app) return openEditModal('application', app);
  }
  if (task.type === 'networking') {
    const contact = state.contacts.find(c => c.id === task.refId);
    if (contact) return openEditModal('networking', contact);
  }
  if (task.type === 'event') {
    const event = state.events.find(e => e.id === task.refId);
    if (event) return openEditModal('event', event);
  }
}

function openEditModal(type, entity) {
  // Reuse add modals with prefill and a Save button
  if (type === 'application') {
    document.getElementById('newAppCompany').value = entity.company || '';
    document.getElementById('newAppRole').value = entity.role || '';
    document.getElementById('newAppUrl').value = entity.url || '';
    document.getElementById('newAppDeadline').value = entity.deadline || '';
    document.getElementById('newAppNotes').value = entity.notes || '';
    const modal = document.getElementById('addAppModal');
    modal.classList.add('active');
    // Swap primary button to Save
    const btns = modal.querySelectorAll('.btn-group button');
    if (btns[0]) { btns[0].textContent = 'Save'; btns[0].onclick = function() { saveEditedApplication(entity.id); }; }
  } else if (type === 'networking') {
    document.getElementById('newContactName').value = entity.name || '';
    document.getElementById('newContactRel').value = entity.relationship || 'Professional Contact';
    document.getElementById('newContactCompany').value = entity.company || '';
    document.getElementById('newContactNotes').value = entity.notes || '';
    const modal = document.getElementById('addContactModal');
    modal.classList.add('active');
    const btns = modal.querySelectorAll('.btn-group button');
    if (btns[0]) { btns[0].textContent = 'Save'; btns[0].onclick = function() { saveEditedContact(entity.id); }; }
  } else if (type === 'event') {
    document.getElementById('newEventName').value = entity.name || '';
    document.getElementById('newEventDate').value = entity.date || '';
    document.getElementById('newEventDuration').value = entity.duration || 120;
    document.getElementById('newEventType').value = entity.type || 'networking';
    document.getElementById('newEventNotes').value = entity.notes || '';
    const modal = document.getElementById('addEventModal');
    modal.classList.add('active');
    const btns = modal.querySelectorAll('.btn-group button');
    if (btns[0]) { btns[0].textContent = 'Save'; btns[0].onclick = function() { saveEditedEvent(entity.id); }; }
  }
}

function saveEditedApplication(appId) {
  const app = state.applications.find(a => a.id === appId);
  if (!app) return;
  app.company = document.getElementById('newAppCompany').value.trim();
  app.role = document.getElementById('newAppRole').value.trim();
  app.url = document.getElementById('newAppUrl').value.trim();
  app.deadline = document.getElementById('newAppDeadline').value || null;
  app.notes = document.getElementById('newAppNotes').value.trim();
  saveToFirebase();
  closeModal('addAppModal');
  renderPlanScreen();
  renderTodayTasks();
}

function saveEditedContact(contactId) {
  const contact = state.contacts.find(c => c.id === contactId);
  if (!contact) return;
  contact.name = document.getElementById('newContactName').value.trim();
  contact.relationship = document.getElementById('newContactRel').value;
  contact.company = document.getElementById('newContactCompany').value.trim();
  contact.notes = document.getElementById('newContactNotes').value.trim();
  saveToFirebase();
  closeModal('addContactModal');
  renderPlanScreen();
  renderTodayTasks();
}

function saveEditedEvent(eventId) {
  const event = state.events.find(e => e.id === eventId);
  if (!event) return;
  event.name = document.getElementById('newEventName').value.trim();
  event.date = document.getElementById('newEventDate').value;
  event.duration = parseInt(document.getElementById('newEventDuration').value) || 120;
  event.type = document.getElementById('newEventType').value;
  event.notes = document.getElementById('newEventNotes').value.trim();
  saveToFirebase();
  closeModal('addEventModal');
  renderPlanScreen();
  renderTodayTasks();
}

function addApplication() {
  const company = document.getElementById('newAppCompany').value.trim();
  const role = document.getElementById('newAppRole').value.trim();
  const url = document.getElementById('newAppUrl').value.trim();
  const deadline = document.getElementById('newAppDeadline').value;
  const notes = document.getElementById('newAppNotes').value.trim();
  
  if (!company || !role) {
    alert('Please fill in company and role');
    return;
  }
  
  const app = {
    id: generateId(),
    company: company,
    role: role,
    status: 'queued',
    dateAdded: getTodayISO(),
    url: url,
    deadline: deadline || null,
    notes: notes
  };
  
  state.applications.push(app);
  saveToFirebase();
  
  // Clear form
  document.getElementById('newAppCompany').value = '';
  document.getElementById('newAppRole').value = '';
  document.getElementById('newAppUrl').value = '';
  document.getElementById('newAppDeadline').value = '';
  document.getElementById('newAppNotes').value = '';
  
  closeModal('addAppModal');
  renderPlanScreen();
}

function addContact() {
  const name = document.getElementById('newContactName').value.trim();
  const relationship = document.getElementById('newContactRel').value;
  const company = document.getElementById('newContactCompany').value.trim();
  const notes = document.getElementById('newContactNotes').value.trim();
  
  if (!name) {
    alert('Please fill in contact name');
    return;
  }
  
  const contact = {
    id: generateId(),
    name: name,
    relationship: relationship,
    company: company,
    notes: notes
  };
  
  state.contacts.push(contact);
  saveToFirebase();
  
  // Clear form
  document.getElementById('newContactName').value = '';
  document.getElementById('newContactRel').value = 'Friend/Ally';
  document.getElementById('newContactCompany').value = '';
  document.getElementById('newContactNotes').value = '';
  
  closeModal('addContactModal');
  renderPlanScreen();
}

function addEvent() {
  const name = document.getElementById('newEventName').value.trim();
  const date = document.getElementById('newEventDate').value;
  const duration = parseInt(document.getElementById('newEventDuration').value);
  const type = document.getElementById('newEventType').value;
  const notes = document.getElementById('newEventNotes').value.trim();
  
  if (!name || !date) {
    alert('Please fill in event name and date');
    return;
  }
  
  const event = {
    id: generateId(),
    name: name,
    date: date,
    duration: duration,
    type: type,
    notes: notes,
    attended: false
  };
  
  state.events.push(event);
  saveToFirebase();
  
  // Clear form
  document.getElementById('newEventName').value = '';
  document.getElementById('newEventDate').value = '';
  document.getElementById('newEventDuration').value = '120';
  document.getElementById('newEventType').value = 'fair';
  document.getElementById('newEventNotes').value = '';
  
  closeModal('addEventModal');
  renderPlanScreen();
}

function saveSettings() {
  state.targets.apps = parseInt(document.getElementById('targetApps').value);
  state.targets.networking = parseInt(document.getElementById('targetNet').value);
  state.targets.events = parseInt(document.getElementById('targetEvents').value);
  
  if (state.guardrails) {
    state.guardrails.maxTailorTime = parseInt(document.getElementById('maxTailorTime').value);
    state.guardrails.maxOptimizationTime = parseInt(document.getElementById('maxOptimizationTime').value);
    state.guardrails.warningThreshold = parseInt(document.getElementById('warningThreshold').value);
  }
  
  saveToFirebase();
  alert('Settings saved!');
  renderProgress();
  renderPlanScreen();
}

function toggleGuardrails() {
  const enabled = document.getElementById('guardrailsEnabled').checked;
  const settings = document.getElementById('guardrailsSettings');
  
  state.guardrails.enabled = enabled;
  settings.style.display = enabled ? 'block' : 'none';
  
  saveToFirebase();
}

function renderSettings() {
  document.getElementById('targetApps').value = state.targets.apps;
  document.getElementById('targetNet').value = state.targets.networking;
  document.getElementById('targetEvents').value = state.targets.events;
  document.getElementById('userId').textContent = userId;
  
  // Update theme toggle
  const themeToggle = document.getElementById('themeToggle');
  if (themeToggle) {
    themeToggle.checked = state.theme === 'light';
  }
  
  // Update guardrails settings
  if (state.guardrails) {
    document.getElementById('guardrailsEnabled').checked = state.guardrails.enabled;
    document.getElementById('maxTailorTime').value = state.guardrails.maxTailorTime;
    document.getElementById('maxOptimizationTime').value = state.guardrails.maxOptimizationTime;
    document.getElementById('warningThreshold').value = state.guardrails.warningThreshold;
    document.getElementById('guardrailsSettings').style.display = state.guardrails.enabled ? 'block' : 'none';
  }
  
  // Update Gmail settings
  if (state.gmail) {
    document.getElementById('gmailClientId').value = state.gmail.clientId || '';
    updateGmailUI();
  }
}

// Gmail Integration Functions
function handleGmailClientIdChange(clientId) {
  state.gmail.clientId = clientId;
  saveToFirebase();
  
  // Initialize Gmail API if we have a client ID
  if (clientId && typeof gapi !== 'undefined') {
    initGoogleAPI().catch(error => {
      console.warn('Gmail API initialization failed:', error);
    });
  }
}

function loadOAuthConfig(environment) {
  const configs = {
    netlify: {
      clientId: '906932405437-9r5i8d63ssle5sqas1fob1k7u4k57bfq.apps.googleusercontent.com',
      redirectUri: 'https://cchute.netlify.app',
      origin: 'https://cchute.netlify.app'
    },
    localhost: {
      clientId: '906932405437-9r5i8d63ssle5sqas1fob1k7u4k57bfq.apps.googleusercontent.com',
      redirectUri: 'http://localhost:8000',
      origin: 'http://localhost:8000'
    }
  };
  
  const config = configs[environment];
  if (config) {
    document.getElementById('gmailClientId').value = config.clientId;
    state.gmail.clientId = config.clientId;
    state.gmail.redirectUri = config.redirectUri;
    saveToFirebase();
    
    // Only initialize if not already initialized
    if (typeof gapi !== 'undefined' && (!gapi.auth2 || !gapi.auth2.getAuthInstance())) {
      initGoogleAPI().catch(error => {
        console.warn('Gmail API initialization failed:', error);
      });
    } else {
      console.log('Gmail API already initialized, skipping re-initialization');
    }
    
    console.log(`Loaded ${environment} OAuth config`);
  }
}

function saveOAuthConfig() {
  const clientId = document.getElementById('gmailClientId').value;
  if (clientId) {
    state.gmail.clientId = clientId;
    saveToFirebase();
    console.log('OAuth config saved');
  }
}

function testOAuthConfig() {
  const currentOrigin = window.location.origin;
  const clientId = state.gmail.clientId;
  const redirectUri = state.gmail.redirectUri;
  
  console.log('=== OAuth Configuration Test ===');
  console.log('Current Origin:', currentOrigin);
  console.log('Client ID:', clientId);
  console.log('Redirect URI:', redirectUri);
  
  let message = `OAuth Configuration Test:\n\n`;
  message += `Current Origin: ${currentOrigin}\n`;
  message += `Client ID: ${clientId ? 'Set' : 'Not Set'}\n`;
  message += `Redirect URI: ${redirectUri || 'Not Set'}\n\n`;
  
  if (currentOrigin === 'https://cchute.netlify.app') {
    message += `For Netlify, you need to add to Google Cloud Console:\n`;
    message += `- Authorized JavaScript origins: https://cchute.netlify.app\n`;
    message += `- Authorized redirect URIs: https://cchute.netlify.app\n\n`;
  } else if (currentOrigin === 'http://localhost:8000') {
    message += `For Localhost, you need to add to Google Cloud Console:\n`;
    message += `- Authorized JavaScript origins: http://localhost:8000\n`;
    message += `- Authorized redirect URIs: http://localhost:8000\n\n`;
  }
  
  message += `Click "Netlify" or "Localhost" button to configure for your current domain.`;
  
  alert(message);
}

function resetGmailAPI() {
  if (typeof gapi !== 'undefined' && gapi.auth2) {
    const authInstance = gapi.auth2.getAuthInstance();
    if (authInstance) {
      authInstance.disconnect();
      console.log('Gmail API disconnected');
    }
  }
  
  // Clear the state
  state.gmail.connected = false;
  state.gmail.userEmail = null;
  state.gmail.accessToken = null;
  state.gmail.tokenExpiry = null;
  
  updateGmailUI();
  saveToFirebase();
  
  console.log('Gmail API reset, you can now try connecting again');
  alert('Gmail API reset. Please try connecting again.');
}

function initGoogleAPI() {
  if (typeof gapi === 'undefined') {
    console.error('Google APIs not loaded');
    return Promise.reject('Google APIs not loaded');
  }
  
  // Check if already initialized
  if (gapi.auth2 && gapi.auth2.getAuthInstance()) {
    console.log('Gmail API already initialized, skipping...');
    checkTokenExpiry();
    return Promise.resolve();
  }
  
  return new Promise((resolve, reject) => {
    gapi.load('client:auth2', () => {
      const config = {
        discoveryDocs: ['https://gmail.googleapis.com/$discovery/rest?version=v1'],
        clientId: state.gmail.clientId,
        scope: 'https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/gmail.modify'
      };
      
      // Add redirect URI if available
      if (state.gmail.redirectUri) {
        config.redirect_uri = state.gmail.redirectUri;
      }
      
      gapi.client.init(config).then(() => {
        console.log('Gmail API initialized with redirect URI:', state.gmail.redirectUri || 'default');
        checkTokenExpiry();
        resolve();
      }).catch(error => {
        console.error('Gmail API initialization failed:', error);
        reject(error);
      });
    });
  });
}

function connectGmail() {
  if (!state.gmail.clientId) {
    alert('Please enter your Google Client ID first');
    return;
  }
  
  if (typeof gapi === 'undefined') {
    alert('Google APIs not loaded. Please refresh the page.');
    return;
  }
  
  const authInstance = gapi.auth2.getAuthInstance();
  if (!authInstance) {
    alert('Gmail API not initialized. Please refresh the page.');
    return;
  }
  
  // Check if we're on the right domain for OAuth
  const currentOrigin = window.location.origin;
  if (currentOrigin === 'https://cchute.netlify.app' && !state.gmail.redirectUri?.includes('cchute.netlify.app')) {
    alert('Please click "Netlify" button first to configure OAuth for this domain');
    return;
  }
  if (currentOrigin === 'http://localhost:8000' && !state.gmail.redirectUri?.includes('localhost')) {
    alert('Please click "Localhost" button first to configure OAuth for this domain');
    return;
  }
  
  console.log('Starting Gmail OAuth flow...');
  console.log('Current origin:', window.location.origin);
  console.log('Configured redirect URI:', state.gmail.redirectUri);
  
  authInstance.signIn().then(googleUser => {
    console.log('OAuth flow completed successfully');
    const authResponse = googleUser.getAuthResponse();
    const profile = googleUser.getBasicProfile();
    
    state.gmail.connected = true;
    state.gmail.userEmail = profile.getEmail();
    state.gmail.accessToken = authResponse.access_token;
    state.gmail.tokenExpiry = Date.now() + (authResponse.expires_in * 1000);
    
    updateGmailUI();
    saveToFirebase();
    
    console.log('Gmail connected successfully');
    alert(`Gmail connected as ${state.gmail.userEmail}`);
  }).catch(error => {
    console.error('Gmail connection failed:', error);
    console.error('Error details:', JSON.stringify(error, null, 2));
    
    if (error.error === 'popup_closed_by_user') {
      alert('Gmail popup was closed. This usually means:\n\n1. The redirect URI is not configured in Google Cloud Console\n2. The popup was blocked by your browser\n3. You closed the popup before completing the flow\n\nPlease check Google Cloud Console and ensure both:\n- Authorized JavaScript origins: https://cchute.netlify.app\n- Authorized redirect URIs: https://cchute.netlify.app');
    } else if (error.error === 'access_denied') {
      alert('Gmail access was denied. Please try again and grant the necessary permissions.');
    } else {
      alert('Failed to connect to Gmail: ' + (error.error || error.message || 'Unknown error'));
    }
  });
}

function disconnectGmail() {
  if (typeof gapi !== 'undefined' && gapi.auth2) {
    const authInstance = gapi.auth2.getAuthInstance();
    if (authInstance) {
      authInstance.signOut();
    }
  }
  
  state.gmail.connected = false;
  state.gmail.userEmail = null;
  state.gmail.accessToken = null;
  state.gmail.tokenExpiry = null;
  state.gmail.lastScanTime = null;
  state.gmail.lastScanResults = { added: 0, duplicates: 0, emailsProcessed: 0 };
  
  updateGmailUI();
  saveToFirebase();
  
  console.log('Gmail disconnected');
}

function checkTokenExpiry() {
  if (!state.gmail.connected || !state.gmail.tokenExpiry) {
    return;
  }
  
  const now = Date.now();
  const timeUntilExpiry = state.gmail.tokenExpiry - now;
  
  // Refresh token if it expires in less than 5 minutes
  if (timeUntilExpiry < 5 * 60 * 1000) {
    if (typeof gapi !== 'undefined' && gapi.auth2) {
      const authInstance = gapi.auth2.getAuthInstance();
      if (authInstance) {
        const googleUser = authInstance.currentUser.get();
        googleUser.reloadAuthResponse().then(authResponse => {
          state.gmail.accessToken = authResponse.access_token;
          state.gmail.tokenExpiry = Date.now() + (authResponse.expires_in * 1000);
          saveToFirebase();
          console.log('Gmail token refreshed');
        }).catch(error => {
          console.error('Token refresh failed:', error);
          disconnectGmail();
        });
      }
    }
  }
}

function updateGmailUI() {
  const statusText = document.getElementById('gmailStatusText');
  const connectBtn = document.getElementById('connectGmailBtn');
  const disconnectBtn = document.getElementById('disconnectGmailBtn');
  const scanBtn = document.getElementById('scanEmailsBtn');
  
  if (state.gmail.connected) {
    statusText.textContent = `Connected as ${state.gmail.userEmail}`;
    statusText.style.color = 'var(--ok)';
    
    if (connectBtn) connectBtn.style.display = 'none';
    if (disconnectBtn) disconnectBtn.style.display = 'inline-block';
    if (scanBtn) scanBtn.style.display = 'inline-block';
    
    // Show last scan info if available
    if (state.gmail.lastScanTime) {
      const lastScanDate = new Date(state.gmail.lastScanTime);
      const lastScanInfo = document.getElementById('gmailLastScan');
      if (lastScanInfo) {
        lastScanInfo.innerHTML = `
          <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
            Last scan: ${lastScanDate.toLocaleString()}<br>
            Added: ${state.gmail.lastScanResults.added} tasks, 
            Duplicates: ${state.gmail.lastScanResults.duplicates}, 
            Processed: ${state.gmail.lastScanResults.emailsProcessed} emails
          </div>
        `;
      }
    }
  } else {
    statusText.textContent = 'Not connected';
    statusText.style.color = 'var(--muted)';
    
    if (connectBtn) connectBtn.style.display = 'inline-block';
    if (disconnectBtn) disconnectBtn.style.display = 'none';
    if (scanBtn) scanBtn.style.display = 'none';
    
    const lastScanInfo = document.getElementById('gmailLastScan');
    if (lastScanInfo) {
      lastScanInfo.innerHTML = '';
    }
  }
}

// Job Queue Functions
function renderJobQueue() {
  const container = document.getElementById('jobQueueTable');
  if (!container) return;
  
  // Get all applications and sort by priority
  const jobs = (state.applications || []).map(app => ({
    ...app,
    matchScore: calculateJobScore(app),
    priority: getJobPriority(app)
  })).sort((a, b) => b.matchScore - a.matchScore);
  
  console.log('Rendering job queue with', jobs.length, 'jobs');
  
  if (jobs.length === 0) {
    container.innerHTML = `
      <div style="padding: 40px; text-align: center; color: var(--muted);">
        <div style="font-size: 48px; margin-bottom: 16px;">📋</div>
        <h3>No jobs in queue</h3>
        <p>Scan Gmail or add jobs manually to get started</p>
        <p style="font-size: 12px; margin-top: 8px;">Current applications: ${state.applications?.length || 0}</p>
      </div>
    `;
    return;
  }
  
  // Create table header
  const tableHTML = `
    <div style="display: grid; grid-template-columns: 40px 1fr 120px 100px 80px 100px 80px 120px; gap: 12px; padding: 16px; background: var(--glass-bg); border-bottom: 1px solid var(--line); font-weight: 600; font-size: 14px;">
      <div>✓</div>
      <div>Company & Role</div>
      <div>Match Score</div>
      <div>Priority</div>
      <div>Salary</div>
      <div>Location</div>
      <div>Status</div>
      <div>Actions</div>
    </div>
    <div id="jobQueueRows">
      ${jobs.map(job => renderJobRow(job)).join('')}
    </div>
  `;
  
  container.innerHTML = tableHTML;
}

function renderJobRow(job) {
  const priorityColor = getPriorityColor(job.priority);
  const statusColor = getStatusColor(job.status);
  
  return `
    <div style="display: grid; grid-template-columns: 40px 1fr 120px 100px 80px 100px 80px 120px; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--line); align-items: center; font-size: 14px;">
      <div>
        <input type="checkbox" onchange="toggleJobSelection('${job.id}')" style="width: 16px; height: 16px;">
      </div>
      <div>
        <div style="font-weight: 600; margin-bottom: 4px;">${job.company}</div>
        <div style="color: var(--muted); font-size: 12px;">${job.role}</div>
      </div>
      <div style="text-align: center;">
        <div style="background: ${getScoreColor(job.matchScore)}; color: white; padding: 4px 8px; border-radius: 12px; font-weight: 600; font-size: 12px;">
          ${job.matchScore}%
        </div>
      </div>
      <div style="text-align: center;">
        <span style="background: ${priorityColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
          ${job.priority}
        </span>
      </div>
      <div style="text-align: center; color: var(--muted);">
        ${job.salary || 'N/A'}
      </div>
      <div style="text-align: center; color: var(--muted);">
        ${job.location || 'N/A'}
      </div>
      <div style="text-align: center;">
        <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
          ${job.status}
        </span>
      </div>
      <div style="display: flex; gap: 4px; justify-content: center;">
        <button class="icon-btn" onclick="editJob('${job.id}')" title="Edit">✏️</button>
        <button class="icon-btn" onclick="deleteJob('${job.id}')" title="Delete">🗑️</button>
        <button class="icon-btn" onclick="viewJobDetails('${job.id}')" title="View">👁️</button>
      </div>
    </div>
  `;
}

function calculateJobScore(job) {
  // Use a deterministic score based on job properties
  let score = 50; // Base score
  
  // Title-based scoring
  const title = (job.role || '').toLowerCase();
  if (title.includes('solutions engineer') || title.includes('sales engineer') || title.includes('customer success engineer')) {
    score += 30;
  } else if (title.includes('account manager') || title.includes('business development')) {
    score += 20;
  } else if (title.includes('customer service') || title.includes('data entry')) {
    score -= 20;
  }
  
  // Company-based scoring (if available)
  if (job.company) {
    const company = job.company.toLowerCase();
    if (company.includes('tech') || company.includes('saas') || company.includes('software')) {
      score += 10;
    }
  }
  
  // Status-based scoring
  if (job.status === 'sent') score += 5;
  if (job.status === 'interview') score += 10;
  
  return Math.min(100, Math.max(0, score));
}

function getJobPriority(job) {
  const score = calculateJobScore(job);
  if (score >= 80) return 'Hot';
  if (score >= 60) return 'High';
  if (score >= 40) return 'Medium';
  return 'Low';
}

function getPriorityColor(priority) {
  const colors = {
    'Hot': 'var(--bad)',
    'High': 'var(--warn)',
    'Medium': 'var(--accent)',
    'Low': 'var(--muted)'
  };
  return colors[priority] || 'var(--muted)';
}

function getStatusColor(status) {
  const colors = {
    'queued': 'var(--muted)',
    'tailoring': 'var(--warn)',
    'ready': 'var(--accent)',
    'sent': 'var(--ok)',
    'interview': 'var(--accent)',
    'rejected': 'var(--bad)',
    'offer': 'var(--ok)'
  };
  return colors[status] || 'var(--muted)';
}

function getScoreColor(score) {
  if (score >= 80) return 'var(--ok)';
  if (score >= 60) return 'var(--warn)';
  return 'var(--bad)';
}

function scanJobAlerts() {
  if (!state.gmail.connected) {
    alert('Please connect Gmail first');
    return;
  }
  
  // This will be implemented in Phase 3
  alert('Gmail scanning will be implemented next!');
}

function addJobManually() {
  // Open a modal to add job manually
  alert('Manual job addition will be implemented next!');
}

function exportJobQueue() {
  // Export to CSV or Google Sheets
  alert('Export functionality will be implemented next!');
}

function openJobPrioritizationSettings() {
  document.getElementById('jobPrioritizationModal').style.display = 'flex';
  renderPrioritizationSettings();
}

function closeJobPrioritizationSettings() {
  document.getElementById('jobPrioritizationModal').style.display = 'none';
}

function renderPrioritizationSettings() {
  const container = document.getElementById('prioritizationSettings');
  container.innerHTML = `
    <div style="display: grid; gap: 20px;">
      <div>
        <h4>Scoring Weights</h4>
        <div style="display: grid; gap: 12px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <label>Job Title Fit</label>
            <input type="range" min="0" max="50" value="30" style="width: 200px;">
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <label>Location Preference</label>
            <input type="range" min="0" max="50" value="20" style="width: 200px;">
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <label>Salary Alignment</label>
            <input type="range" min="0" max="50" value="15" style="width: 200px;">
          </div>
        </div>
      </div>
      
      <div>
        <h4>Job Title Grades</h4>
        <div style="display: grid; gap: 8px; font-size: 12px;">
          <div><strong>Grade A (Excellent Fit):</strong> Solutions Engineer, Sales Engineer, Customer Success Engineer...</div>
          <div><strong>Grade B (Moderate Fit):</strong> Account Manager, Business Development Manager...</div>
          <div><strong>Grade C (Low Fit):</strong> Customer Service Rep, Data Entry Clerk...</div>
        </div>
      </div>
      
      <div>
        <h4>Your Preferences</h4>
        <div style="display: grid; gap: 12px;">
          <div>
            <label>Preferred Location Type</label>
            <select style="width: 100%; padding: 8px; border-radius: 6px;">
              <option value="remote">Remote</option>
              <option value="hybrid">Hybrid</option>
              <option value="onsite">Onsite</option>
            </select>
          </div>
          <div>
            <label>Target Salary Range</label>
            <input type="text" placeholder="e.g., 80000-120000" style="width: 100%; padding: 8px; border-radius: 6px;">
          </div>
        </div>
      </div>
    </div>
  `;
}

function syncToUserId() {
  const newUserId = document.getElementById('syncUserIdInput').value.trim();
  if (!newUserId) {
    alert('Please enter a User ID');
    return;
  }
  
  if (newUserId === userId) {
    alert('This is already your current User ID');
    return;
  }
  
  if (confirm(`Switch to User ID: ${newUserId}?\n\nThis will load data from that account and sync with other devices using the same ID.`)) {
    // Save current data to localStorage as backup
    localStorage.setItem('career_chute_backup_' + userId, JSON.stringify(state));
    
    // Switch to new User ID
    userId = newUserId;
    localStorage.setItem('career_chute_userId', userId);
    
    // Clear current state
    state = {
      weekStart: getWeekStart(),
      targets: { apps: 15, net: 10 },
      apps: [],
      contacts: [],
      dailyTasks: {},
      weekDone: { apps: 0, net: 0 },
      taskProgress: {},
      streak: 0,
      theme: 'dark'
    };
    
    // Update UI immediately
    renderSettings();
    document.getElementById('syncUserIdInput').value = '';
    
    // Load data from new User ID
    if (firebaseAvailable && db) {
      updateSyncStatus('syncing', 'Loading data...');
      db.collection('users').doc(userId).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          if (data.lastUpdated) {
            state = { ...state, ...data };
            delete state.lastUpdated;
            
            // Re-render everything
            renderTodayTasks();
            renderPlanScreen();
            renderSettings();
            
            updateSyncStatus('synced', 'Synced');
            setTimeout(() => updateSyncStatus('', 'Cloud'), 2000);
            
            alert('Successfully synced with other device!');
          } else {
            alert('No data found for this User ID');
          }
        } else {
          alert('No data found for this User ID');
        }
      }).catch(error => {
        console.error('Sync error:', error);
        updateSyncStatus('error', 'Error');
        alert('Failed to load data from other device');
      });
    } else {
      alert('Firebase not available - cannot sync data');
    }
  }
}

function forceOfflineMode() {
  if (confirm('Force offline mode?\n\nThis will load your local data and bypass Firebase connection. You can sync later when connection is restored.')) {
    updateSyncStatus('error', 'Offline');
    loadFromLocalStorage();
    alert('Switched to offline mode. Your local data is loaded.');
  }
}

// Emergency global function - can be called from browser console
window.emergencyOffline = function() {
  console.log('Emergency offline mode triggered');
  updateSyncStatus('error', 'Offline');
  loadFromLocalStorage();
  alert('Emergency offline mode activated!');
};

// List all users in Firebase (for debugging)
function listAllUsers() {
  if (!firebaseAvailable || !db) {
    alert('Firebase not available');
    return;
  }
  
  updateSyncStatus('syncing', 'Loading users...');
  
  db.collection('users').get().then(querySnapshot => {
    let userList = 'Found ' + querySnapshot.size + ' users:\n\n';
    querySnapshot.forEach(doc => {
      const data = doc.data();
      const lastUpdated = data.lastUpdated ? new Date(data.lastUpdated).toLocaleString() : 'Never';
      const taskCount = data.dailyTasks ? Object.keys(data.dailyTasks).length : 0;
      userList += `ID: ${doc.id}\n`;
      userList += `Last Updated: ${lastUpdated}\n`;
      userList += `Tasks: ${taskCount}\n`;
      userList += `Apps: ${data.apps ? data.apps.length : 0}\n\n`;
    });
    
    updateSyncStatus('synced', 'Users loaded');
    alert(userList);
  }).catch(error => {
    console.error('Error loading users:', error);
    updateSyncStatus('error', 'Error');
    alert('Failed to load users: ' + error.message);
  });
}

// Clean up old users and migrate to shared user
function cleanupAndMigrateUsers() {
  if (!firebaseAvailable || !db) {
    alert('Firebase not available');
    return;
  }
  
  if (confirm('This will merge all user data into a single shared account and delete old users. Continue?')) {
    updateSyncStatus('syncing', 'Migrating users...');
    
    db.collection('users').get().then(querySnapshot => {
      let mergedData = {
        weekStart: getWeekStart(),
        targets: { apps: 15, net: 10 },
        apps: [],
        contacts: [],
        dailyTasks: {},
        weekDone: { apps: 0, net: 0 },
        taskProgress: {},
        streak: 0,
        theme: 'dark'
      };
      
      let userCount = 0;
      let promises = [];
      
      querySnapshot.forEach(doc => {
        if (doc.id !== SHARED_USER_ID) {
          userCount++;
          const data = doc.data();
          
          // Merge data (keep the most recent/complete data)
          if (data.apps && data.apps.length > mergedData.apps.length) {
            mergedData.apps = data.apps;
          }
          if (data.contacts && data.contacts.length > mergedData.contacts.length) {
            mergedData.contacts = data.contacts;
          }
          if (data.dailyTasks) {
            Object.assign(mergedData.dailyTasks, data.dailyTasks);
          }
          if (data.weekDone) {
            mergedData.weekDone = data.weekDone;
          }
          if (data.taskProgress) {
            Object.assign(mergedData.taskProgress, data.taskProgress);
          }
          if (data.streak > mergedData.streak) {
            mergedData.streak = data.streak;
          }
          if (data.theme) {
            mergedData.theme = data.theme;
          }
          
          // Delete old user
          promises.push(db.collection('users').doc(doc.id).delete());
        }
      });
      
      // Save merged data to shared user
      promises.push(db.collection('users').doc(SHARED_USER_ID).set({
        ...mergedData,
        lastUpdated: new Date().toISOString()
      }));
      
      Promise.all(promises).then(() => {
        updateSyncStatus('synced', 'Migration complete');
        alert(`Migration complete! Merged ${userCount} users into shared account.`);
        
        // Reload the app with merged data
        state = mergedData;
        renderTodayTasks();
        renderPlanScreen();
        renderSettings();
      }).catch(error => {
        console.error('Migration error:', error);
        updateSyncStatus('error', 'Migration failed');
        alert('Migration failed: ' + error.message);
      });
    });
  }
}

function exportData() {
  const dataStr = JSON.stringify(state, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'career-chute-data.json';
  link.click();
  URL.revokeObjectURL(url);
}

function importData() {
  document.getElementById('importFileInput').click();
}

document.getElementById('importFileInput').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importedData = JSON.parse(e.target.result);
      if (confirm('This will replace all current data. Continue?')) {
        state = { ...state, ...importedData };
        initializeWeekAndDay();
        saveToFirebase();
        renderTodayTasks();
        renderProgress();
        renderPlanScreen();
        renderSettings();
        alert('Data imported successfully!');
      }
    } catch (error) {
      alert('Invalid file format');
    }
  };
  reader.readAsText(file);
});

function confirmReset() {
  if (confirm('This will delete ALL your data. This cannot be undone. Continue?')) {
    if (confirm('Are you absolutely sure? This will reset everything.')) {
      localStorage.clear();
      location.reload();
    }
  }
}

</script>

<!-- Settings Screen -->
<div id="settings-screen" class="screen">
  <div class="top-bar">
    <button class="ghost" onclick="goHome()">← Back</button>
    <h2>Settings</h2>
    <div style="width:60px"></div>
  </div>
  
  <div style="padding: 20px;">
    <div class="setting-section">
      <h3 style="margin-bottom: 16px;">Data Management</h3>
      
      <button onclick="exportData()" style="width: 100%; margin-bottom: 12px;">
        📦 Export All Data (JSON)
      </button>
      
      <button onclick="document.getElementById('import-file').click()" class="secondary" style="width: 100%; margin-bottom: 12px;">
        📥 Import Data
      </button>
      <input type="file" id="import-file" accept=".json" style="display:none;" onchange="importData(event)">
      
      <button onclick="confirmClearData()" class="ghost" style="width: 100%; color: var(--bad);">
        🗑️ Clear All Data
      </button>
    </div>
    
    <div class="setting-section" style="margin-top: 32px;">
      <h3 style="margin-bottom: 16px;">About</h3>
      <p style="color: var(--muted); font-size: 14px;">
        Career Chute v3.0<br>
        Track your job search progress<br>
        All data stored locally on your device
      </p>
    </div>
  </div>
</div>

<!-- Modal Overlay -->
<div id="modal-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;" onclick="closeModal()">
  <div id="modal-content" style="background:var(--panel); border-radius:16px; padding:32px; max-width:400px; margin:20px;" onclick="event.stopPropagation()">
    <h2 id="modal-title" style="margin-bottom:16px;"></h2>
    <p id="modal-message" style="color:var(--muted); margin-bottom:24px;"></p>
    <div id="modal-buttons" style="display:flex; gap:12px;"></div>
  </div>
</div>

<!-- Celebration Overlay -->
<div id="celebration-overlay" class="celebration-overlay">
  <div>
    <div class="breathing-circle"></div>
    <div class="breathing-text">🎉 Nice work!</div>
  </div>
</div>

<style>
.setting-section {
  background: var(--panel);
  border: 1px solid var(--line);
  border-radius: 12px;
  padding: 20px;
}

@keyframes breathe {
  0%, 100% { transform: scale(1); opacity: 0.6; }
  50% { transform: scale(1.3); opacity: 1; }
}

@keyframes confetti {
  0% { transform: translateY(0) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}

.celebration-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  z-index: 9998;
  display: none;
  align-items: center;
  justify-content: center;
}

.celebration-overlay.active {
  display: flex;
}

.breathing-circle {
  width: 150px;
  height: 150px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--ok));
  animation: breathe 4s ease-in-out infinite;
  margin: 0 auto;
}

.breathing-text {
  text-align: center;
  font-size: 24px;
  font-weight: 600;
  color: var(--text);
  margin-top: 30px;
}

.confetti-piece {
  position: fixed;
  width: 10px;
  height: 10px;
  animation: confetti 3s ease-out forwards;
  z-index: 9999;
}
</style>

</body>
</html>